<!-- Premium Inventory Management Dashboard -->
<div class="inventory-dashboard">

    <!-- Gradient Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Gestion des Stocks</h1>
            <p class="subtitle">Vue d'ensemble et gestion de l'inventaire</p>
        </div>
        <div class="header-actions">
            <button mat-raised-button (click)="checkAutoReorders()">
                <mat-icon>autorenew</mat-icon>
                Vérifier Réapprovisionnement
            </button>
            <button mat-raised-button color="primary" [matMenuTriggerFor]="exportMenu">
                <mat-icon>download</mat-icon>
                Exporter
            </button>
            <mat-menu #exportMenu="matMenu">
                <button mat-menu-item (click)="exportToCSV('inventory')">Inventaire Global</button>
                <button mat-menu-item (click)="exportToCSV('movements')">Mouvements de Stock</button>
                <button mat-menu-item (click)="exportToCSV('orders')">Commandes d'Achat</button>
            </mat-menu>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <mat-card>
            <div class="kpi-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <mat-icon>inventory_2</mat-icon>
            </div>
            <h3>{{ stats().totalProducts }}</h3>
            <p>Produits en Stock</p>
        </mat-card>

        <mat-card>
            <div class="kpi-icon" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
                <mat-icon>attach_money</mat-icon>
            </div>
            <h3>{{ stats().totalValue | number:'1.0-0' }} MAD</h3>
            <p>Valeur Totale</p>
        </mat-card>

        <mat-card>
            <div class="kpi-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);">
                <mat-icon>warning</mat-icon>
            </div>
            <h3>{{ stats().lowStockItems }}</h3>
            <p>Stock Faible</p>
        </mat-card>

        <mat-card>
            <div class="kpi-icon" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);">
                <mat-icon>local_shipping</mat-icon>
            </div>
            <h3>{{ stats().pendingPOs }}</h3>
            <p>Commandes en Cours</p>
        </mat-card>
    </div>

    <!-- Main Content -->
    <div class="main-content-card">
        <mat-card>
            <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="selectedTabIndex.set($event)">

                <!-- Suppliers Tab -->
                <mat-tab label="Fournisseurs">
                    <div class="tab-content">
                        <div class="toolbar">
                            <mat-form-field appearance="outline">
                                <mat-label>Rechercher</mat-label>
                                <mat-icon matPrefix>search</mat-icon>
                                <input matInput [value]="supplierSearchQuery()"
                                    (input)="supplierSearchQuery.set($any($event.target).value)">
                            </mat-form-field>
                            <button mat-raised-button color="primary" (click)="openSupplierDialog()">
                                <mat-icon>add</mat-icon>
                                Nouveau Fournisseur
                            </button>
                        </div>

                        <table mat-table [dataSource]="filteredSuppliers()">
                            <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef>Nom</th>
                                <td mat-cell *matCellDef="let s">{{ s.name }}</td>
                            </ng-container>

                            <ng-container matColumnDef="contact">
                                <th mat-header-cell *matHeaderCellDef>Contact</th>
                                <td mat-cell *matCellDef="let s">
                                    <div>{{ s.email }}</div>
                                    <div>{{ s.phone }}</div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="address">
                                <th mat-header-cell *matHeaderCellDef>Adresse</th>
                                <td mat-cell *matCellDef="let s">{{ s.address }}</td>
                            </ng-container>

                            <ng-container matColumnDef="productsCount">
                                <th mat-header-cell *matHeaderCellDef>Produits</th>
                                <td mat-cell *matCellDef="let s">{{ s.productsCount || 0 }}</td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>Statut</th>
                                <td mat-cell *matCellDef="let s">
                                    <span class="status-badge" [class.active]="s.isActive">
                                        {{ s.isActive ? 'Actif' : 'Inactif' }}
                                    </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let s">
                                    <button mat-icon-button (click)="editSupplier(s)">
                                        <mat-icon>edit</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="supplierColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: supplierColumns;"></tr>
                        </table>
                    </div>
                </mat-tab>

                <!-- Purchase Orders Tab -->
                <mat-tab label="Commandes">
                    <div class="tab-content">
                        <div class="toolbar">
                            <mat-form-field appearance="outline">
                                <mat-label>Rechercher</mat-label>
                                <mat-icon matPrefix>search</mat-icon>
                                <input matInput [value]="poSearchQuery()"
                                    (input)="poSearchQuery.set($any($event.target).value)">
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>Statut</mat-label>
                                <mat-select [value]="poStatusFilter()" (valueChange)="poStatusFilter.set($event)">
                                    <mat-option value="ALL">Tous</mat-option>
                                    <mat-option value="DRAFT">Brouillon</mat-option>
                                    <mat-option value="PENDING">En attente</mat-option>
                                    <mat-option value="RECEIVED">Reçu</mat-option>
                                </mat-select>
                            </mat-form-field>
                            <button mat-raised-button color="primary" (click)="openPurchaseOrderDialog()">
                                <mat-icon>add</mat-icon>
                                Nouvelle Commande
                            </button>
                        </div>

                        <table mat-table [dataSource]="filteredPurchaseOrders()">
                            <ng-container matColumnDef="orderNumber">
                                <th mat-header-cell *matHeaderCellDef>N° Commande</th>
                                <td mat-cell *matCellDef="let po">{{ po.poNumber }}</td>
                            </ng-container>

                            <ng-container matColumnDef="supplier">
                                <th mat-header-cell *matHeaderCellDef>Fournisseur</th>
                                <td mat-cell *matCellDef="let po">{{ po.supplier?.name }}</td>
                            </ng-container>

                            <ng-container matColumnDef="orderDate">
                                <th mat-header-cell *matHeaderCellDef>Date</th>
                                <td mat-cell *matCellDef="let po">{{ po.orderDate | date:'dd/MM/yyyy' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="expectedDate">
                                <th mat-header-cell *matHeaderCellDef>Livraison</th>
                                <td mat-cell *matCellDef="let po">{{ po.expectedDeliveryDate | date:'dd/MM/yyyy' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="totalAmount">
                                <th mat-header-cell *matHeaderCellDef>Montant</th>
                                <td mat-cell *matCellDef="let po">{{ po.totalAmount | number:'1.2-2' }} MAD</td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>Statut</th>
                                <td mat-cell *matCellDef="let po">
                                    <span class="status-badge" [ngClass]="'status-' + po.status.toLowerCase()">
                                        {{ getStatusLabel(po.status) }}
                                    </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let po">
                                    <button mat-icon-button (click)="viewPurchaseOrder(po)">
                                        <mat-icon>visibility</mat-icon>
                                    </button>
                                    <button mat-icon-button (click)="editPurchaseOrder(po)">
                                        <mat-icon>edit</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="purchaseOrderColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: purchaseOrderColumns;"></tr>
                        </table>
                    </div>
                </mat-tab>

                <!-- Stock Movements Tab -->
                <mat-tab label="Mouvements">
                    <div class="tab-content">
                        <div class="toolbar">
                            <mat-form-field appearance="outline">
                                <mat-label>Rechercher</mat-label>
                                <mat-icon matPrefix>search</mat-icon>
                                <input matInput [value]="movementSearchQuery()"
                                    (input)="movementSearchQuery.set($any($event.target).value)">
                            </mat-form-field>
                            <button mat-raised-button color="primary" (click)="openStockMovementDialog()">
                                <mat-icon>add</mat-icon>
                                Nouveau Mouvement
                            </button>
                        </div>

                        <table mat-table [dataSource]="filteredStockMovements()">
                            <ng-container matColumnDef="date">
                                <th mat-header-cell *matHeaderCellDef>Date</th>
                                <td mat-cell *matCellDef="let m">{{ m.movementDate | date:'dd/MM/yyyy HH:mm' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="product">
                                <th mat-header-cell *matHeaderCellDef>Produit</th>
                                <td mat-cell *matCellDef="let m">{{ m.product?.name }}</td>
                            </ng-container>

                            <ng-container matColumnDef="type">
                                <th mat-header-cell *matHeaderCellDef>Type</th>
                                <td mat-cell *matCellDef="let m">
                                    <span class="movement-badge" [ngClass]="'movement-' + m.movementType.toLowerCase()">
                                        {{ getMovementLabel(m.movementType) }}
                                    </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="quantity">
                                <th mat-header-cell *matHeaderCellDef>Quantité</th>
                                <td mat-cell *matCellDef="let m">{{ m.quantity }}</td>
                            </ng-container>

                            <ng-container matColumnDef="reference">
                                <th mat-header-cell *matHeaderCellDef>Référence</th>
                                <td mat-cell *matCellDef="let m">{{ m.referenceId || '-' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="notes">
                                <th mat-header-cell *matHeaderCellDef>Notes</th>
                                <td mat-cell *matCellDef="let m">{{ m.notes || '-' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="user">
                                <th mat-header-cell *matHeaderCellDef>Utilisateur</th>
                                <td mat-cell *matCellDef="let m">{{ m.performedBy || '-' }}</td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="movementColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: movementColumns;"></tr>
                        </table>
                    </div>
                </mat-tab>

                <!-- Reorder Settings Tab -->
                <mat-tab label="Réapprovisionnement">
                    <div class="tab-content">
                        <div class="toolbar">
                            <mat-form-field appearance="outline">
                                <mat-label>Rechercher</mat-label>
                                <mat-icon matPrefix>search</mat-icon>
                                <input matInput [value]="reorderSearchQuery()"
                                    (input)="reorderSearchQuery.set($any($event.target).value)">
                            </mat-form-field>
                            <button mat-raised-button color="primary" (click)="openReorderSettingDialog()">
                                <mat-icon>add</mat-icon>
                                Nouveau Paramètre
                            </button>
                        </div>

                        <table mat-table [dataSource]="filteredReorderSettings()">
                            <ng-container matColumnDef="product">
                                <th mat-header-cell *matHeaderCellDef>Produit</th>
                                <td mat-cell *matCellDef="let r">{{ r.product?.name }}</td>
                            </ng-container>

                            <ng-container matColumnDef="currentStock">
                                <th mat-header-cell *matHeaderCellDef>Stock Actuel</th>
                                <td mat-cell *matCellDef="let r">{{ r.product?.stock || 0 }}</td>
                            </ng-container>

                            <ng-container matColumnDef="reorderPoint">
                                <th mat-header-cell *matHeaderCellDef>Seuil</th>
                                <td mat-cell *matCellDef="let r">{{ r.reorderPoint }}</td>
                            </ng-container>

                            <ng-container matColumnDef="reorderQuantity">
                                <th mat-header-cell *matHeaderCellDef>Quantité</th>
                                <td mat-cell *matCellDef="let r">{{ r.reorderQuantity }}</td>
                            </ng-container>

                            <ng-container matColumnDef="supplier">
                                <th mat-header-cell *matHeaderCellDef>Fournisseur</th>
                                <td mat-cell *matCellDef="let r">{{ r.supplier?.name || '-' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="autoReorder">
                                <th mat-header-cell *matHeaderCellDef>Auto</th>
                                <td mat-cell *matCellDef="let r">
                                    <mat-slide-toggle [checked]="r.autoReorder"
                                        (change)="toggleAutoReorder(r, $event.checked)">
                                    </mat-slide-toggle>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>Statut</th>
                                <td mat-cell *matCellDef="let r">
                                    <span class="status-badge"
                                        [class.warning]="(r.product?.stock || 0) <= r.reorderPoint">
                                        {{ (r.product?.stock || 0) <= r.reorderPoint ? 'À commander' : 'OK' }} </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let r">
                                    <button mat-icon-button (click)="editReorderSetting(r)">
                                        <mat-icon>edit</mat-icon>
                                    </button>
                                    <button mat-icon-button (click)="deleteReorderSetting(r.id)">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="reorderColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: reorderColumns;"></tr>
                        </table>
                    </div>
                </mat-tab>

            </mat-tab-group>
        </mat-card>
    </div>

</div>