<!-- ========================================================== -->
<!-- WORLD-CLASS INVENTORY MANAGEMENT - Premium Enterprise UI -->
<!-- Inspired by Shopify, Square, Zoho, and Linear -->
<!-- ========================================================== -->

<div class="inventory-container">

    <!-- Premium Floating Header -->
    <header class="inventory-header">
        <div class="header-left">
            <div class="page-title-section">
                <div class="title-badge">
                    <mat-icon>inventory_2</mat-icon>
                </div>
                <div class="title-content">
                    <h1>Gestion des Stocks</h1>
                    <p class="breadcrumb">Admin / Inventaire / Vue d'ensemble</p>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="header-stats">
                <div class="mini-stat">
                    <span class="stat-value">{{ stats().totalProducts }}</span>
                    <span class="stat-label">Produits</span>
                </div>
                <div class="mini-stat success">
                    <span class="stat-value">{{ stats().healthyStockItems || 0 }}</span>
                    <span class="stat-label">En stock</span>
                </div>
                @if (stats().outOfStockItems > 0) {
                <div class="mini-stat danger pulse">
                    <span class="stat-value">{{ stats().outOfStockItems }}</span>
                    <span class="stat-label">Ruptures</span>
                </div>
                }
            </div>
            <div class="header-actions">
                <button class="btn-icon" matTooltip="Actualiser" (click)="refreshAll()">
                    <mat-icon>sync</mat-icon>
                </button>
                <button class="btn-secondary" [matMenuTriggerFor]="exportMenu">
                    <mat-icon>download</mat-icon>
                    <span>Exporter</span>
                </button>
                <mat-menu #exportMenu="matMenu" class="premium-menu">
                    <button mat-menu-item (click)="exportToCSV('inventory')">
                        <mat-icon>table_view</mat-icon>
                        <span>Inventaire complet</span>
                    </button>
                    <button mat-menu-item (click)="exportToCSV('movements')">
                        <mat-icon>swap_vert</mat-icon>
                        <span>Mouvements de stock</span>
                    </button>
                </mat-menu>
                <button class="btn-primary" (click)="openStockMovementDialog()">
                    <mat-icon>add</mat-icon>
                    <span>Mouvement</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Analytics Overview Section -->
    <section class="analytics-grid">
        <!-- Stock Health Overview -->
        <div class="analytics-card stock-health">
            <div class="card-header">
                <h3>Santé du Stock</h3>
                <span class="update-badge">
                    <mat-icon>schedule</mat-icon>
                    {{ lastUpdateTime || 'À jour' }}
                </span>
            </div>
            <div class="card-body">
                <div class="health-chart">
                    <div class="donut-chart">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle healthy" [attr.stroke-dasharray]="getHealthyStockPercentage() + ', 100'"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="chart-center">
                            <span class="percentage">{{ getHealthyStockPercentage() }}%</span>
                            <span class="label">Optimal</span>
                        </div>
                    </div>
                </div>
                <div class="health-legend">
                    <div class="legend-item success">
                        <span class="dot"></span>
                        <span class="name">Stock optimal</span>
                        <span class="value">{{ stats().healthyStockItems || 0 }}</span>
                    </div>
                    <div class="legend-item warning">
                        <span class="dot"></span>
                        <span class="name">Stock faible</span>
                        <span class="value">{{ stats().lowStockItems }}</span>
                    </div>
                    <div class="legend-item danger">
                        <span class="dot"></span>
                        <span class="name">Rupture</span>
                        <span class="value">{{ stats().outOfStockItems }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Value Overview -->
        <div class="analytics-card value-overview">
            <div class="card-header">
                <h3>Valeur du Stock</h3>
                <div class="trend-badge positive">
                    <mat-icon>trending_up</mat-icon>
                    <span>+12%</span>
                </div>
            </div>
            <div class="card-body">
                <div class="value-display">
                    <span class="currency">TND</span>
                    <span class="amount">{{ stats().totalValue | number:'1.0-0' }}</span>
                </div>
                <div class="value-breakdown">
                    <div class="breakdown-item">
                        <mat-icon>inventory</mat-icon>
                        <div class="info">
                            <span class="name">Produits actifs</span>
                            <span class="value">{{ stats().totalProducts }}</span>
                        </div>
                    </div>
                    <div class="breakdown-item">
                        <mat-icon>local_shipping</mat-icon>
                        <div class="info">
                            <span class="name">Commandes en cours</span>
                            <span class="value">{{ stats().pendingPOs }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="analytics-card quick-actions">
            <div class="card-header">
                <h3>Actions Rapides</h3>
            </div>
            <div class="card-body">
                <div class="action-grid">
                    <button class="action-tile" (click)="checkAutoReorders()">
                        <div class="tile-icon purple">
                            <mat-icon>autorenew</mat-icon>
                        </div>
                        <span>Réappro Auto</span>
                    </button>
                    <button class="action-tile" (click)="openSupplierDialog()">
                        <div class="tile-icon blue">
                            <mat-icon>business</mat-icon>
                        </div>
                        <span>Fournisseur</span>
                    </button>
                    <button class="action-tile" (click)="openPurchaseOrderDialog()">
                        <div class="tile-icon green">
                            <mat-icon>receipt_long</mat-icon>
                        </div>
                        <span>Commande</span>
                    </button>
                    <button class="action-tile" (click)="selectedTabIndex.set(4)">
                        <div class="tile-icon orange">
                            <mat-icon>tune</mat-icon>
                        </div>
                        <span>Paramètres</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alerts Panel -->
        <div class="analytics-card alerts-panel"
            [class.has-alerts]="stats().outOfStockItems > 0 || stats().lowStockItems > 0">
            <div class="card-header">
                <h3>
                    <mat-icon>notifications_active</mat-icon>
                    Alertes Stock
                </h3>
                @if (stats().outOfStockItems + stats().lowStockItems > 0) {
                <span class="alert-count">{{ stats().outOfStockItems + stats().lowStockItems }}</span>
                }
            </div>
            <div class="card-body">
                @if (stats().outOfStockItems > 0) {
                <div class="alert-item critical">
                    <div class="alert-icon">
                        <mat-icon>error</mat-icon>
                    </div>
                    <div class="alert-content">
                        <span class="alert-title">{{ stats().outOfStockItems }} produit(s) en rupture</span>
                        <span class="alert-action" (click)="selectedTabIndex.set(0)">Voir les produits →</span>
                    </div>
                </div>
                }
                @if (stats().lowStockItems > 0) {
                <div class="alert-item warning">
                    <div class="alert-icon">
                        <mat-icon>warning</mat-icon>
                    </div>
                    <div class="alert-content">
                        <span class="alert-title">{{ stats().lowStockItems }} produit(s) stock faible</span>
                        <span class="alert-action" (click)="selectedTabIndex.set(0)">Commander →</span>
                    </div>
                </div>
                }
                @if (stats().pendingPOs > 0) {
                <div class="alert-item info">
                    <div class="alert-icon">
                        <mat-icon>local_shipping</mat-icon>
                    </div>
                    <div class="alert-content">
                        <span class="alert-title">{{ stats().pendingPOs }} commande(s) en attente</span>
                        <span class="alert-action" (click)="selectedTabIndex.set(2)">Suivre →</span>
                    </div>
                </div>
                }
                @if (stats().outOfStockItems === 0 && stats().lowStockItems === 0 && stats().pendingPOs === 0) {
                <div class="no-alerts">
                    <mat-icon>check_circle</mat-icon>
                    <span>Tout est en ordre !</span>
                </div>
                }
            </div>
        </div>
    </section>

    <!-- Main Content Area -->
    <section class="main-content">
        <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="selectedTabIndex.set($event)"
            class="premium-tabs">

            <!-- Stock Products Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <div class="tab-label">
                        <mat-icon>inventory</mat-icon>
                        <span>Stock Produits</span>
                        @if (stats().outOfStockItems > 0) {
                        <span class="tab-badge danger">{{ stats().outOfStockItems }}</span>
                        }
                    </div>
                </ng-template>

                <div class="tab-panel">
                    <!-- Search & Filters -->
                    <div class="panel-toolbar">
                        <div class="search-box">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Rechercher un produit..." #searchInput>
                        </div>
                        <div class="filter-chips">
                            <button class="chip active">Tous</button>
                            <button class="chip">En stock</button>
                            <button class="chip warning">Stock faible</button>
                            <button class="chip danger">Rupture</button>
                        </div>
                    </div>

                    <!-- Products Table -->
                    @if (productStock().length === 0) {
                    <div class="empty-state">
                        <div class="empty-icon">
                            <mat-icon>inventory_2</mat-icon>
                        </div>
                        <h3>Aucun produit en stock</h3>
                        <p>Les produits de votre inventaire apparaîtront ici</p>
                    </div>
                    } @else {
                    <div class="data-table-container">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th class="col-product">Produit</th>
                                    <th class="col-sku">SKU</th>
                                    <th class="col-stock">Niveau de Stock</th>
                                    <th class="col-status">État</th>
                                    <th class="col-value">Valeur</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (product of productStock(); track product.id) {
                                <tr [class.critical]="product.status === 'OUT_OF_STOCK'"
                                    [class.warning]="product.status === 'LOW' || product.status === 'CRITICAL'">
                                    <td class="col-product">
                                        <div class="product-info">
                                            <div class="product-avatar">
                                                {{ product.name?.charAt(0) || 'P' }}
                                            </div>
                                            <div class="product-details">
                                                <span class="product-name">{{ product.name }}</span>
                                                <span class="product-category">{{ product.category || 'Non catégorisé'
                                                    }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="col-sku">
                                        <code class="sku-code">{{ product.sku }}</code>
                                    </td>
                                    <td class="col-stock">
                                        <div class="stock-indicator">
                                            <div class="stock-bar-container">
                                                <div class="stock-bar" [class.success]="product.status === 'OK'"
                                                    [class.warning]="product.status === 'LOW'"
                                                    [class.danger]="product.status === 'CRITICAL' || product.status === 'OUT_OF_STOCK'"
                                                    [style.width.%]="Math.min((product.currentStock / 50) * 100, 100)">
                                                </div>
                                            </div>
                                            <span class="stock-count">{{ product.currentStock }} unités</span>
                                        </div>
                                    </td>
                                    <td class="col-status">
                                        <span class="status-pill"
                                            [ngClass]="'status-' + product.status.toLowerCase().replace('_', '-')">
                                            @switch (product.status) {
                                            @case ('OK') { <mat-icon>check_circle</mat-icon> En stock }
                                            @case ('LOW') { <mat-icon>warning</mat-icon> Faible }
                                            @case ('CRITICAL') { <mat-icon>error</mat-icon> Critique }
                                            @case ('OUT_OF_STOCK') { <mat-icon>cancel</mat-icon> Rupture }
                                            }
                                        </span>
                                    </td>
                                    <td class="col-value">
                                        <span class="value-text">{{ product.value | number:'1.2-2' }} TND</span>
                                    </td>
                                    <td class="col-actions">
                                        <div class="action-buttons">
                                            <button class="action-btn" matTooltip="Ajuster stock"
                                                (click)="openStockAdjustment(product)">
                                                <mat-icon>tune</mat-icon>
                                            </button>
                                            <button class="action-btn" matTooltip="Historique"
                                                (click)="viewProductHistory(product)">
                                                <mat-icon>history</mat-icon>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    }
                </div>
            </mat-tab>

            <!-- Suppliers Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <div class="tab-label">
                        <mat-icon>business</mat-icon>
                        <span>Fournisseurs</span>
                    </div>
                </ng-template>

                <div class="tab-panel">
                    <div class="panel-toolbar">
                        <div class="search-box">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Rechercher un fournisseur..."
                                [value]="supplierSearchQuery()"
                                (input)="supplierSearchQuery.set($any($event.target).value)">
                        </div>
                        <button class="btn-primary" (click)="openSupplierDialog()">
                            <mat-icon>add</mat-icon>
                            <span>Nouveau Fournisseur</span>
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Fournisseur</th>
                                    <th>Contact</th>
                                    <th>Adresse</th>
                                    <th>Produits</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (supplier of filteredSuppliers(); track supplier.id) {
                                <tr>
                                    <td>
                                        <div class="supplier-info">
                                            <div class="supplier-avatar">{{ supplier.name?.charAt(0) || 'S' }}</div>
                                            <span class="supplier-name">{{ supplier.name }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="contact-info">
                                            <span>{{ supplier.email }}</span>
                                            <span class="secondary">{{ supplier.phone }}</span>
                                        </div>
                                    </td>
                                    <td>{{ supplier.address }}</td>
                                    <td><span class="count-badge">-</span></td>
                                    <td>
                                        <span class="status-pill" [class.active]="supplier.isActive">
                                            {{ supplier.isActive ? 'Actif' : 'Inactif' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="action-btn" (click)="editSupplier(supplier)">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </mat-tab>

            <!-- Purchase Orders Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <div class="tab-label">
                        <mat-icon>receipt_long</mat-icon>
                        <span>Commandes</span>
                        @if (stats().pendingPOs > 0) {
                        <span class="tab-badge">{{ stats().pendingPOs }}</span>
                        }
                    </div>
                </ng-template>

                <div class="tab-panel">
                    <div class="panel-toolbar">
                        <div class="search-box">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Rechercher une commande..." [value]="poSearchQuery()"
                                (input)="poSearchQuery.set($any($event.target).value)">
                        </div>
                        <div class="filter-chips">
                            <button class="chip" [class.active]="poStatusFilter() === 'ALL'"
                                (click)="poStatusFilter.set('ALL')">Toutes</button>
                            <button class="chip" [class.active]="poStatusFilter() === 'DRAFT'"
                                (click)="poStatusFilter.set('DRAFT')">Brouillon</button>
                            <button class="chip" [class.active]="poStatusFilter() === 'PENDING'"
                                (click)="poStatusFilter.set('PENDING')">En attente</button>
                            <button class="chip" [class.active]="poStatusFilter() === 'RECEIVED'"
                                (click)="poStatusFilter.set('RECEIVED')">Reçues</button>
                        </div>
                        <button class="btn-primary" (click)="openPurchaseOrderDialog()">
                            <mat-icon>add</mat-icon>
                            <span>Nouvelle Commande</span>
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>N° Commande</th>
                                    <th>Fournisseur</th>
                                    <th>Date</th>
                                    <th>Livraison prévue</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (po of filteredPurchaseOrders(); track po.id) {
                                <tr>
                                    <td><code class="order-code">{{ po.poNumber }}</code></td>
                                    <td>{{ po.supplier?.name }}</td>
                                    <td>{{ po.orderDate | date:'dd/MM/yyyy' }}</td>
                                    <td>{{ po.expectedDeliveryDate | date:'dd/MM/yyyy' }}</td>
                                    <td><strong>{{ po.totalAmount | number:'1.2-2' }} TND</strong></td>
                                    <td>
                                        <span class="status-pill" [ngClass]="'status-' + po.status.toLowerCase()">
                                            {{ getStatusLabel(po.status) }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn" (click)="viewPurchaseOrder(po)">
                                                <mat-icon>visibility</mat-icon>
                                            </button>
                                            <button class="action-btn" (click)="editPurchaseOrder(po)">
                                                <mat-icon>edit</mat-icon>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </mat-tab>

            <!-- Stock Movements Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <div class="tab-label">
                        <mat-icon>swap_vert</mat-icon>
                        <span>Mouvements</span>
                    </div>
                </ng-template>

                <div class="tab-panel">
                    <div class="panel-toolbar">
                        <div class="search-box">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Rechercher un mouvement..." [value]="movementSearchQuery()"
                                (input)="movementSearchQuery.set($any($event.target).value)">
                        </div>
                        <button class="btn-primary" (click)="openStockMovementDialog()">
                            <mat-icon>add</mat-icon>
                            <span>Nouveau Mouvement</span>
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Produit</th>
                                    <th>Type</th>
                                    <th>Quantité</th>
                                    <th>Référence</th>
                                    <th>Notes</th>
                                    <th>Utilisateur</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (movement of filteredStockMovements(); track movement.id) {
                                <tr>
                                    <td>{{ movement.movementDate | date:'dd/MM/yyyy HH:mm' }}</td>
                                    <td>{{ movement.product?.name }}</td>
                                    <td>
                                        <span class="movement-type"
                                            [ngClass]="'type-' + movement.movementType.toLowerCase()">
                                            <mat-icon>{{ getMovementIcon(movement.movementType) }}</mat-icon>
                                            {{ getMovementLabel(movement.movementType) }}
                                        </span>
                                    </td>
                                    <td><strong>{{ movement.quantity }}</strong></td>
                                    <td>{{ movement.referenceId || '-' }}</td>
                                    <td>{{ movement.notes || '-' }}</td>
                                    <td>{{ movement.performedBy || '-' }}</td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </mat-tab>

            <!-- Reorder Settings Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <div class="tab-label">
                        <mat-icon>tune</mat-icon>
                        <span>Réappro</span>
                    </div>
                </ng-template>

                <div class="tab-panel">
                    <div class="panel-toolbar">
                        <div class="search-box">
                            <mat-icon>search</mat-icon>
                            <input type="text" placeholder="Rechercher..." [value]="reorderSearchQuery()"
                                (input)="reorderSearchQuery.set($any($event.target).value)">
                        </div>
                        <button class="btn-primary" (click)="openReorderSettingDialog()">
                            <mat-icon>add</mat-icon>
                            <span>Nouveau Paramètre</span>
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Stock Actuel</th>
                                    <th>Seuil</th>
                                    <th>Quantité</th>
                                    <th>Fournisseur</th>
                                    <th>Auto</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (setting of filteredReorderSettings(); track setting.id) {
                                <tr>
                                    <td>{{ setting.product?.name }}</td>
                                    <td>{{ setting.product?.stock || 0 }}</td>
                                    <td>{{ setting.reorderPoint }}</td>
                                    <td>{{ setting.reorderQuantity }}</td>
                                    <td>{{ setting.preferredSupplier?.name || '-' }}</td>
                                    <td>
                                        <mat-slide-toggle [checked]="setting.isEnabled || setting.autoReorder"
                                            (change)="toggleAutoReorder(setting, $event.checked)" color="primary">
                                        </mat-slide-toggle>
                                    </td>
                                    <td>
                                        <span class="status-pill"
                                            [class.warning]="(setting.product?.stock || 0) <= setting.reorderPoint">
                                            {{ (setting.product?.stock || 0) <= setting.reorderPoint ? 'À commander'
                                                : 'OK' }} </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn" (click)="editReorderSetting(setting)">
                                                <mat-icon>edit</mat-icon>
                                            </button>
                                            <button class="action-btn danger"
                                                (click)="deleteReorderSetting(setting.id)">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </mat-tab>

        </mat-tab-group>
    </section>

</div>

<!-- ================== SLIDE-OUT DIALOGS ================== -->

<!-- Supplier Form Dialog -->
@if (showSupplierForm()) {
<div class="modal-overlay" (click)="closeSupplierDialog()">
    <div class="modal-panel slide-in" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ editingSupplier() ? 'Modifier Fournisseur' : 'Nouveau Fournisseur' }}</h2>
            <button class="close-btn" (click)="closeSupplierDialog()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <form [formGroup]="supplierForm" (ngSubmit)="saveSupplier()" class="modal-body">
            <div class="form-group">
                <label>Nom du fournisseur</label>
                <input type="text" formControlName="name" placeholder="Entrez le nom">
            </div>
            <div class="form-group">
                <label>Personne de contact</label>
                <input type="text" formControlName="contactPerson" placeholder="Nom du contact">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" formControlName="email" placeholder="email@exemple.com">
                </div>
                <div class="form-group">
                    <label>Téléphone</label>
                    <input type="tel" formControlName="phone" placeholder="+216 ...">
                </div>
            </div>
            <div class="form-group">
                <label>Adresse</label>
                <textarea formControlName="address" rows="2" placeholder="Adresse complète"></textarea>
            </div>
            <div class="form-group">
                <label>Statut</label>
                <select formControlName="status">
                    <option value="ACTIVE">Actif</option>
                    <option value="INACTIVE">Inactif</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" (click)="closeSupplierDialog()">Annuler</button>
                <button type="submit" class="btn-primary" [disabled]="supplierForm.invalid">
                    <mat-icon>save</mat-icon>
                    {{ editingSupplier() ? 'Mettre à jour' : 'Créer' }}
                </button>
            </div>
        </form>
    </div>
</div>
}

<!-- Stock Movement Dialog -->
@if (showMovementForm()) {
<div class="modal-overlay" (click)="closeMovementDialog()">
    <div class="modal-panel slide-in" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Nouveau Mouvement de Stock</h2>
            <button class="close-btn" (click)="closeMovementDialog()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <form [formGroup]="stockMovementForm" (ngSubmit)="saveStockMovement()" class="modal-body">
            <div class="form-group">
                <label>Produit</label>
                <select formControlName="productId">
                    @for (p of productStock(); track p.id) {
                    <option [value]="p.id">{{ p.name }}</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Type de mouvement</label>
                <div class="movement-type-selector">
                    <button type="button" class="type-btn in"
                        [class.active]="stockMovementForm.get('type')?.value === 'IN'"
                        (click)="stockMovementForm.patchValue({type: 'IN'})">
                        <mat-icon>arrow_downward</mat-icon>
                        <span>Entrée</span>
                    </button>
                    <button type="button" class="type-btn out"
                        [class.active]="stockMovementForm.get('type')?.value === 'OUT'"
                        (click)="stockMovementForm.patchValue({type: 'OUT'})">
                        <mat-icon>arrow_upward</mat-icon>
                        <span>Sortie</span>
                    </button>
                    <button type="button" class="type-btn adjustment"
                        [class.active]="stockMovementForm.get('type')?.value === 'ADJUSTMENT'"
                        (click)="stockMovementForm.patchValue({type: 'ADJUSTMENT'})">
                        <mat-icon>sync</mat-icon>
                        <span>Ajustement</span>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Quantité</label>
                <input type="number" formControlName="quantity" min="1">
            </div>
            <div class="form-group">
                <label>Notes (optionnel)</label>
                <textarea formControlName="notes" rows="2" placeholder="Raison du mouvement..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" (click)="closeMovementDialog()">Annuler</button>
                <button type="submit" class="btn-primary" [disabled]="stockMovementForm.invalid">
                    <mat-icon>check</mat-icon>
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>
}

<!-- PO Details Dialog -->
@if (showPODetails() && selectedPO()) {
<div class="modal-overlay" (click)="closePODetails()">
    <div class="modal-panel slide-in wide" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Commande {{ selectedPO()!.poNumber }}</h2>
            <button class="close-btn" (click)="closePODetails()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <div class="modal-body po-details">
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="label">Fournisseur</span>
                    <span class="value">{{ selectedPO()!.supplier?.name || 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Statut</span>
                    <span class="status-pill" [ngClass]="'status-' + selectedPO()!.status.toLowerCase()">
                        {{ getStatusLabel(selectedPO()!.status) }}
                    </span>
                </div>
                <div class="detail-item">
                    <span class="label">Date de commande</span>
                    <span class="value">{{ selectedPO()!.orderDate | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Livraison prévue</span>
                    <span class="value">{{ selectedPO()!.expectedDeliveryDate | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="detail-item highlight">
                    <span class="label">Montant total</span>
                    <span class="value">{{ selectedPO()!.totalAmount | number:'1.2-2' }} TND</span>
                </div>
            </div>

            @if (selectedPO()!.items && selectedPO()!.items.length > 0) {
            <h3>Articles commandés</h3>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Produit</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Sous-total</th>
                    </tr>
                </thead>
                <tbody>
                    @for (item of selectedPO()!.items; track item.id) {
                    <tr>
                        <td>{{ item.product?.name || 'Produit' }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.unitPrice | number:'1.2-2' }} TND</td>
                        <td>{{ item.totalPrice | number:'1.2-2' }} TND</td>
                    </tr>
                    }
                </tbody>
            </table>
            }

            <div class="modal-footer">
                <button class="btn-secondary" (click)="closePODetails()">Fermer</button>
            </div>
        </div>
    </div>
</div>
}

<!-- Reorder Setting Dialog -->
@if (showReorderForm()) {
<div class="modal-overlay" (click)="closeReorderForm()">
    <div class="modal-panel slide-in" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ editingReorderSetting() ? 'Modifier Paramètre' : 'Nouveau Paramètre de Réapprovisionnement' }}</h2>
            <button class="close-btn" (click)="closeReorderForm()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <form [formGroup]="reorderSettingForm" (ngSubmit)="saveReorderSetting()" class="modal-body">
            <div class="form-group">
                <label>Produit</label>
                <select formControlName="productId">
                    @for (p of productStock(); track p.id) {
                    <option [value]="p.id">{{ p.name }} (Stock: {{ p.currentStock }})</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Point de commande (Seuil)</label>
                    <input type="number" formControlName="reorderPoint" min="0">
                    <span class="hint">Alerte quand stock ≤ cette valeur</span>
                </div>
                <div class="form-group">
                    <label>Quantité à commander</label>
                    <input type="number" formControlName="reorderQuantity" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Stock minimum</label>
                    <input type="number" formControlName="minimumStock" min="0">
                </div>
                <div class="form-group">
                    <label>Stock maximum</label>
                    <input type="number" formControlName="maximumStock" min="1">
                </div>
            </div>
            <div class="form-group">
                <label>Délai de livraison (jours)</label>
                <input type="number" formControlName="leadTimeDays" min="1">
            </div>
            <div class="form-group">
                <label>Fournisseur par défaut</label>
                <select formControlName="supplierId">
                    <option value="">Aucun</option>
                    @for (s of suppliers(); track s.id) {
                    <option [value]="s.id">{{ s.name }}</option>
                    }
                </select>
            </div>
            <div class="form-group checkbox">
                <mat-slide-toggle formControlName="autoReorder" color="primary">
                    Réapprovisionnement automatique
                </mat-slide-toggle>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" (click)="closeReorderForm()">Annuler</button>
                <button type="submit" class="btn-primary" [disabled]="reorderSettingForm.invalid">
                    <mat-icon>save</mat-icon>
                    {{ editingReorderSetting() ? 'Mettre à jour' : 'Créer' }}
                </button>
            </div>
        </form>
    </div>
</div>
}