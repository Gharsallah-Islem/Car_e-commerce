<div class="modern-dashboard">
    <!-- Loading State -->
    @if (loading) {
    <div class="loading-container">
        <div class="loading-spinner">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading analytics...</p>
        </div>
    </div>
    }

    <!-- Dashboard Content -->
    @if (!loading && dashboardStats) {
    <div class="dashboard-content">

        <!-- Welcome Hero -->
        <div class="welcome-hero">
            <div class="hero-content">
                <div class="hero-left">
                    <h1 class="greeting">{{ getGreeting() }}, Admin! <span class="wave">üëã</span></h1>
                    <p class="date-time">{{ currentDate }}</p>
                </div>
                <div class="hero-right">
                    <div class="live-indicator">
                        <span class="pulse-dot"></span>
                        <span>Live</span>
                    </div>
                    <span class="last-sync">
                        <mat-icon>schedule</mat-icon>
                        Last sync: {{ lastSyncTime }}
                    </span>
                    <button mat-stroked-button class="refresh-btn" (click)="refreshData()" [disabled]="refreshing">
                        <mat-icon>refresh</mat-icon>
                        <span>{{ refreshing ? 'Syncing...' : 'Refresh' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Cards Grid -->
        <div class="kpi-grid">
            <!-- Revenue Card -->
            <div class="kpi-card revenue">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Revenue</span>
                        <mat-icon class="info-icon"
                            matTooltip="Total revenue for the selected period">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon revenue">
                        <mat-icon>payments</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalRevenue | number:'1.0-0' }} <span
                        class="currency">TND</span></div>
                @if (dashboardStats.revenueGrowth) {
                <div class="kpi-change" [class.positive]="dashboardStats.revenueGrowth > 0"
                    [class.negative]="dashboardStats.revenueGrowth < 0">
                    <mat-icon>{{ getGrowthIcon(dashboardStats.revenueGrowth) }}</mat-icon>
                    <span>{{ formatPercentage(Math.abs(dashboardStats.revenueGrowth)) }}</span>
                    <span class="period">vs last month</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="revenueSparklineOption" [merge]="revenueSparklineOption"
                        style="height: 50px;"></div>
                </div>
            </div>

            <!-- Orders Card -->
            <div class="kpi-card orders">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Orders</span>
                        <mat-icon class="info-icon" matTooltip="Number of orders received">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon orders">
                        <mat-icon>shopping_cart</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalOrders | number }}</div>
                @if (dashboardStats.ordersGrowth) {
                <div class="kpi-change" [class.positive]="dashboardStats.ordersGrowth > 0"
                    [class.negative]="dashboardStats.ordersGrowth < 0">
                    <mat-icon>{{ getGrowthIcon(dashboardStats.ordersGrowth) }}</mat-icon>
                    <span>{{ formatPercentage(Math.abs(dashboardStats.ordersGrowth)) }}</span>
                    <span class="period">vs last month</span>
                </div>
                }
                @if (dashboardStats.pendingOrders > 0) {
                <div class="kpi-note">
                    <span class="badge">{{ dashboardStats.pendingOrders }} pending</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="ordersSparklineOption" [merge]="ordersSparklineOption"
                        style="height: 50px;"></div>
                </div>
            </div>

            <!-- Users Card -->
            <div class="kpi-card users">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Customers</span>
                        <mat-icon class="info-icon" matTooltip="Registered customers">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon users">
                        <mat-icon>people</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalUsers | number }}</div>
                @if (dashboardStats.usersGrowth) {
                <div class="kpi-change" [class.positive]="dashboardStats.usersGrowth > 0"
                    [class.negative]="dashboardStats.usersGrowth < 0">
                    <mat-icon>{{ getGrowthIcon(dashboardStats.usersGrowth) }}</mat-icon>
                    <span>{{ formatPercentage(Math.abs(dashboardStats.usersGrowth)) }}</span>
                    <span class="period">vs last month</span>
                </div>
                }
                @if (dashboardStats.activeUsers) {
                <div class="kpi-note">
                    <span class="badge">{{ dashboardStats.activeUsers }} active</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="usersSparklineOption" [merge]="usersSparklineOption" style="height: 50px;">
                    </div>
                </div>
            </div>

            <!-- Products Card -->
            <div class="kpi-card products">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Products</span>
                        <mat-icon class="info-icon" matTooltip="Products in catalog">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon products">
                        <mat-icon>inventory_2</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalProducts | number }}</div>
                @if (dashboardStats.lowStockProducts > 0) {
                <div class="kpi-note warning">
                    <mat-icon>warning</mat-icon>
                    <span>{{ dashboardStats.lowStockProducts }} low stock</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="productsSparklineOption" [merge]="productsSparklineOption"
                        style="height: 50px;"></div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-btn" routerLink="/admin/products">
                <mat-icon>add_circle</mat-icon>
                <span>Add Product</span>
            </button>
            <button class="action-btn" routerLink="/admin/orders">
                <mat-icon>shopping_bag</mat-icon>
                <span>View Orders</span>
            </button>
            <button class="action-btn" routerLink="/admin/users">
                <mat-icon>group</mat-icon>
                <span>Manage Users</span>
            </button>
            <button class="action-btn" routerLink="/admin/inventory">
                <mat-icon>inventory</mat-icon>
                <span>Inventory</span>
            </button>
            <button class="action-btn" (click)="exportReport()">
                <mat-icon>download</mat-icon>
                <span>Export Report</span>
            </button>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="section-header">
                <h2>Analytics Overview</h2>
                <div class="period-tabs">
                    <button class="period-btn" [class.active]="selectedPeriod === '7D'"
                        (click)="changePeriod('7D')">7D</button>
                    <button class="period-btn" [class.active]="selectedPeriod === '30D'"
                        (click)="changePeriod('30D')">30D</button>
                    <button class="period-btn" [class.active]="selectedPeriod === '90D'"
                        (click)="changePeriod('90D')">90D</button>
                    <button class="period-btn" [class.active]="selectedPeriod === '1Y'"
                        (click)="changePeriod('1Y')">1Y</button>
                </div>
            </div>
        </div>

        <!-- Main Charts Grid -->
        <div class="charts-grid">
            <!-- Revenue Trend Chart (Full Width) -->
            <div class="chart-card full-width">
                <div class="card-header">
                    <div class="header-left">
                        <h3>Revenue Trend</h3>
                        <p class="subtitle">Daily revenue with comparison to previous period</p>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn" matTooltip="Expand">
                            <mat-icon>fullscreen</mat-icon>
                        </button>
                        <button class="icon-btn" matTooltip="Download">
                            <mat-icon>download</mat-icon>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    @if (salesChartData.length > 0) {
                    <div echarts [options]="revenueChartOption" [merge]="revenueChartOption" style="height: 350px;">
                    </div>
                    } @else {
                    <div class="no-data">
                        <mat-icon>show_chart</mat-icon>
                        <p>No revenue data available</p>
                    </div>
                    }
                </div>
            </div>

            <!-- Sales Funnel -->
            <div class="chart-card half-width funnel-card">
                <div class="card-header">
                    <div class="header-left">
                        <h3>Conversion Funnel</h3>
                        <p class="subtitle">Customer journey analysis</p>
                    </div>
                </div>
                <div class="card-content">
                    <div class="funnel-container">
                        @for (step of funnelData; track step.label) {
                        <div class="funnel-step">
                            <div class="step-bar" [style.width.%]="step.percentage"></div>
                            <div class="step-info">
                                <span class="step-label">{{ step.label }}</span>
                                <span class="step-value">{{ step.value | number }}</span>
                                @if (step.rate) {
                                <span class="step-rate">{{ step.rate }}%</span>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Category Performance -->
            <div class="chart-card half-width">
                <div class="card-header">
                    <div class="header-left">
                        <h3>Sales by Category</h3>
                        <p class="subtitle">Revenue breakdown by product category</p>
                    </div>
                </div>
                <div class="card-content">
                    @if (categoryPerformance.length > 0) {
                    <div echarts [options]="categoryChartOption" [merge]="categoryChartOption" style="height: 280px;">
                    </div>
                    } @else {
                    <div class="no-data">
                        <mat-icon>bar_chart</mat-icon>
                        <p>No category data available</p>
                    </div>
                    }
                </div>
            </div>

            <!-- Order Status Donut -->
            <div class="chart-card half-width">
                <div class="card-header">
                    <div class="header-left">
                        <h3>Order Status</h3>
                        <p class="subtitle">Distribution of order statuses</p>
                    </div>
                </div>
                <div class="card-content">
                    @if (orderStatusDistribution.length > 0) {
                    <div echarts [options]="orderStatusChartOption" [merge]="orderStatusChartOption"
                        style="height: 280px;"></div>
                    } @else {
                    <div class="no-data">
                        <mat-icon>donut_small</mat-icon>
                        <p>No order data available</p>
                    </div>
                    }
                </div>
            </div>

            <!-- Sales Heatmap -->
            <div class="chart-card half-width heatmap-card">
                <div class="card-header">
                    <div class="header-left">
                        <h3>Sales Heatmap</h3>
                        <p class="subtitle">Peak selling times by day and hour</p>
                    </div>
                </div>
                <div class="card-content">
                    <div echarts [options]="heatmapChartOption" [merge]="heatmapChartOption" style="height: 280px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Gauges -->
        <div class="gauges-row">
            <div class="gauge-card">
                <div class="gauge-title">Revenue Target</div>
                <div class="gauge-chart">
                    <div echarts [options]="revenueGaugeOption" [merge]="revenueGaugeOption" style="height: 120px;">
                    </div>
                </div>
                <div class="gauge-value">{{ revenueTargetPercent }}<span>%</span></div>
                <div class="gauge-label">of monthly target</div>
            </div>
            <div class="gauge-card">
                <div class="gauge-title">Order Fulfillment</div>
                <div class="gauge-chart">
                    <div echarts [options]="fulfillmentGaugeOption" [merge]="fulfillmentGaugeOption"
                        style="height: 120px;"></div>
                </div>
                <div class="gauge-value">{{ fulfillmentRate }}<span>%</span></div>
                <div class="gauge-label">on-time delivery</div>
            </div>
            <div class="gauge-card">
                <div class="gauge-title">Customer Satisfaction</div>
                <div class="gauge-chart">
                    <div echarts [options]="satisfactionGaugeOption" [merge]="satisfactionGaugeOption"
                        style="height: 120px;"></div>
                </div>
                <div class="gauge-value">{{ customerSatisfaction }}<span>/5</span></div>
                <div class="gauge-label">average rating</div>
            </div>
        </div>

        <!-- Top Products Table -->
        @if (topProducts.length > 0) {
        <div class="data-card">
            <div class="card-header">
                <div class="header-left">
                    <span class="trophy-icon">üèÜ</span>
                    <div>
                        <h3>Top Selling Products</h3>
                        <p class="subtitle">Best performing products this month</p>
                    </div>
                </div>
                <button mat-button class="view-all-btn" routerLink="/admin/products">View All</button>
            </div>
            <div class="card-content">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th class="text-right">Units Sold</th>
                            <th class="text-right">Revenue</th>
                            <th style="width: 120px;">Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (product of topProducts; track product.productId; let i = $index) {
                        <tr>
                            <td>
                                <span class="rank-badge" [ngClass]="{ 
                                    'gold': i === 0, 
                                    'silver': i === 1, 
                                    'bronze': i === 2,
                                    'default': i > 2 
                                }">
                                    {{ i + 1 }}
                                </span>
                            </td>
                            <td>
                                <div class="product-cell">
                                    <div class="product-image">
                                        <img [src]="product.imageUrl" [alt]="product.productName" loading="lazy">
                                    </div>
                                    <span class="product-name">{{ product.productName }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="category-badge">{{ product.category }}</span>
                            </td>
                            <td>{{ product.brand }}</td>
                            <td class="text-right">
                                <strong>{{ product.unitsSold }}</strong>
                            </td>
                            <td class="text-right">
                                <span class="revenue-value">{{ product.revenue | number:'1.0-0' }} TND</span>
                            </td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress-fill" [style.width.%]="getProductProgress(product)"></div>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        }

        <!-- Recent Activities -->
        @if (recentActivities.length > 0) {
        <div class="data-card">
            <div class="card-header">
                <div class="header-left">
                    <div>
                        <h3>Live Activity Feed</h3>
                        <p class="subtitle">Real-time updates from your store</p>
                    </div>
                </div>
                <button mat-button class="view-all-btn">View All</button>
            </div>
            <div class="card-content">
                <div class="activity-list">
                    @for (activity of recentActivities; track activity.timestamp) {
                    <div class="activity-item">
                        <div class="activity-icon" [ngClass]="getActivityClass(activity.type)">
                            <mat-icon>{{ getActivityIcon(activity.type) }}</mat-icon>
                        </div>
                        <div class="activity-content">
                            <p class="activity-description">{{ activity.description }}</p>
                            <div class="activity-meta">
                                <span class="activity-user">{{ activity.userName }}</span>
                            </div>
                        </div>
                        <span class="activity-time">{{ getRelativeTime(activity.timestamp) }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
        }
    </div>
    }
</div>