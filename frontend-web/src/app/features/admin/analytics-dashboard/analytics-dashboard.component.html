<div class="modern-dashboard">
    <!-- Loading State -->
    @if (loading) {
    <div class="loading-container">
        <div class="loading-spinner">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading analytics...</p>
        </div>
    </div>
    }

    <!-- Dashboard Content -->
    @if (!loading && dashboardStats) {
    <div class="dashboard-content">

        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-left">
                <h1>Dashboard</h1>
                <p class="subtitle">Welcome back! Here's what's happening with your store.</p>
            </div>
            <div class="header-actions">
                <button mat-stroked-button class="action-btn" (click)="refreshData()" [disabled]="refreshing">
                    <mat-icon>refresh</mat-icon>
                    <span>Refresh</span>
                </button>
                <button mat-stroked-button class="action-btn">
                    <mat-icon>file_download</mat-icon>
                    <span>Export</span>
                </button>
            </div>
        </div>

        <!-- KPI Cards Grid -->
        <div class="kpi-grid">
            <!-- Revenue Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Revenue</span>
                        <mat-icon class="info-icon"
                            matTooltip="Total revenue for the selected period">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon revenue">
                        <mat-icon>payments</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalRevenue | number:'1.2-2' }} <span
                        class="currency">TND</span></div>
                @if (dashboardStats.revenueGrowth) {
                <div class="kpi-change" [class.positive]="dashboardStats.revenueGrowth > 0"
                    [class.negative]="dashboardStats.revenueGrowth < 0">
                    <mat-icon>{{ getGrowthIcon(dashboardStats.revenueGrowth) }}</mat-icon>
                    <span>{{ formatPercentage(Math.abs(dashboardStats.revenueGrowth)) }}</span>
                    <span class="period">vs last month</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="revenueSparklineOption" [merge]="revenueSparklineOption"
                        style="height: 40px;"></div>
                </div>
            </div>

            <!-- Orders Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Orders</span>
                        <mat-icon class="info-icon" matTooltip="Number of orders received">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon orders">
                        <mat-icon>shopping_cart</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalOrders | number }}</div>
                @if (dashboardStats.ordersGrowth) {
                <div class="kpi-change" [class.positive]="dashboardStats.ordersGrowth > 0"
                    [class.negative]="dashboardStats.ordersGrowth < 0">
                    <mat-icon>{{ getGrowthIcon(dashboardStats.ordersGrowth) }}</mat-icon>
                    <span>{{ formatPercentage(Math.abs(dashboardStats.ordersGrowth)) }}</span>
                    <span class="period">vs last month</span>
                </div>
                }
                @if (dashboardStats.pendingOrders > 0) {
                <div class="kpi-note">
                    <span class="badge">{{ dashboardStats.pendingOrders }} pending</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="ordersSparklineOption" [merge]="ordersSparklineOption"
                        style="height: 40px;"></div>
                </div>
            </div>

            <!-- Users Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Users</span>
                        <mat-icon class="info-icon" matTooltip="Registered users">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon users">
                        <mat-icon>people</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalUsers | number }}</div>
                @if (dashboardStats.usersGrowth) {
                <div class="kpi-change" [class.positive]="dashboardStats.usersGrowth > 0"
                    [class.negative]="dashboardStats.usersGrowth < 0">
                    <mat-icon>{{ getGrowthIcon(dashboardStats.usersGrowth) }}</mat-icon>
                    <span>{{ formatPercentage(Math.abs(dashboardStats.usersGrowth)) }}</span>
                    <span class="period">vs last month</span>
                </div>
                }
                @if (dashboardStats.activeUsers) {
                <div class="kpi-note">
                    <span class="badge">{{ dashboardStats.activeUsers }} active</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="usersSparklineOption" [merge]="usersSparklineOption" style="height: 40px;">
                    </div>
                </div>
            </div>

            <!-- Products Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <span class="label">Total Products</span>
                        <mat-icon class="info-icon" matTooltip="Products in catalog">info_outline</mat-icon>
                    </div>
                    <div class="kpi-icon products">
                        <mat-icon>inventory_2</mat-icon>
                    </div>
                </div>
                <div class="kpi-value">{{ dashboardStats.totalProducts | number }}</div>
                @if (dashboardStats.lowStockProducts > 0) {
                <div class="kpi-note warning">
                    <mat-icon>warning</mat-icon>
                    <span>{{ dashboardStats.lowStockProducts }} low stock</span>
                </div>
                }
                <div class="kpi-sparkline">
                    <div echarts [options]="productsSparklineOption" [merge]="productsSparklineOption"
                        style="height: 40px;"></div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Revenue Chart -->
            <div class="chart-card full-width">
                <div class="card-header">
                    <div class="header-left">
                        <h3>Revenue Overview</h3>
                        <p class="subtitle">Daily revenue for the last 30 days</p>
                    </div>
                    <div class="header-actions">
                        <button mat-button class="filter-btn">Last 30 days</button>
                    </div>
                </div>
                <div class="card-content">
                    @if (salesChartData.length > 0) {
                    <div echarts [options]="revenueChartOption" [merge]="revenueChartOption" style="height: 350px;">
                    </div>
                    } @else {
                    <div class="no-data">
                        <mat-icon>show_chart</mat-icon>
                        <p>No data available</p>
                    </div>
                    }
                </div>
            </div>

            <!-- Category Performance -->
            <div class="chart-card">
                <div class="card-header">
                    <h3>Sales by Category</h3>
                    <p class="subtitle">Revenue breakdown by product category</p>
                </div>
                <div class="card-content">
                    @if (categoryPerformance.length > 0) {
                    <div echarts [options]="categoryChartOption" [merge]="categoryChartOption" style="height: 300px;">
                    </div>
                    } @else {
                    <div class="no-data">
                        <mat-icon>bar_chart</mat-icon>
                        <p>No data available</p>
                    </div>
                    }
                </div>
            </div>

            <!-- Order Status -->
            <div class="chart-card">
                <div class="card-header">
                    <h3>Order Status</h3>
                    <p class="subtitle">Distribution of order statuses</p>
                </div>
                <div class="card-content">
                    @if (orderStatusDistribution.length > 0) {
                    <div echarts [options]="orderStatusChartOption" [merge]="orderStatusChartOption"
                        style="height: 300px;"></div>
                    } @else {
                    <div class="no-data">
                        <mat-icon>donut_small</mat-icon>
                        <p>No data available</p>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Top Products Table -->
        @if (topProducts.length > 0) {
        <div class="data-card">
            <div class="card-header">
                <h3>Top Selling Products</h3>
                <p class="subtitle">Best performing products this month</p>
            </div>
            <div class="card-content">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th class="text-right">Units Sold</th>
                            <th class="text-right">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (product of topProducts; track product.productId) {
                        <tr>
                            <td>
                                <div class="product-cell">
                                    <div class="product-image">
                                        <img [src]="product.imageUrl" [alt]="product.productName">
                                    </div>
                                    <span class="product-name">{{ product.productName }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="category-badge">{{ product.category }}</span>
                            </td>
                            <td>{{ product.brand }}</td>
                            <td class="text-right">
                                <strong>{{ product.unitsSold }}</strong>
                            </td>
                            <td class="text-right">
                                <strong class="revenue-value">{{ product.revenue | number:'1.2-2' }} TND</strong>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        }

        <!-- Recent Activities -->
        @if (recentActivities.length > 0) {
        <div class="data-card">
            <div class="card-header">
                <h3>Recent Activity</h3>
                <p class="subtitle">Latest actions in your store</p>
            </div>
            <div class="card-content">
                <div class="activity-list">
                    @for (activity of recentActivities; track activity.timestamp) {
                    <div class="activity-item">
                        <div class="activity-icon">
                            <mat-icon>{{ getActivityIcon(activity.type) }}</mat-icon>
                        </div>
                        <div class="activity-content">
                            <p class="activity-description">{{ activity.description }}</p>
                            <div class="activity-meta">
                                <span class="activity-user">{{ activity.userName }}</span>
                                <span class="activity-time">{{ activity.timestamp | date:'medium' }}</span>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
        }
    </div>
    }
</div>