<!-- Delivery Management Header -->
<div class="delivery-header">
    <div class="header-content">
        <div class="title-section">
            <mat-icon class="header-icon">local_shipping</mat-icon>
            <div>
                <h1>Gestion des Livraisons</h1>
                <p class="subtitle">Suivez et gérez toutes vos livraisons en temps réel</p>
            </div>
        </div>
        <div class="header-actions">
            <button mat-raised-button color="primary" (click)="exportToCSV()">
                <mat-icon>download</mat-icon>
                Exporter
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <mat-card class="stat-card stat-primary">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>local_shipping</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ stats().totalDeliveries || 0 }}</h3>
                <p>Total Livraisons</p>
            </div>
        </div>
    </mat-card>

    <mat-card class="stat-card stat-warning">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>inventory</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ stats().processing || 0 }}</h3>
                <p>En Préparation</p>
            </div>
        </div>
    </mat-card>

    <mat-card class="stat-card stat-info">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>delivery_dining</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ (stats().inTransit || 0) + (stats().outForDelivery || 0) }}</h3>
                <p>En Cours</p>
            </div>
        </div>
    </mat-card>

    <mat-card class="stat-card stat-success">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>check_circle</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ stats().delivered || 0 }}</h3>
                <p>Livrées</p>
            </div>
        </div>
    </mat-card>

    <mat-card class="stat-card stat-danger">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>error</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ stats().failed || 0 }}</h3>
                <p>Échecs</p>
            </div>
        </div>
    </mat-card>

    <mat-card class="stat-card stat-purple">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>schedule</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ (stats().averageDeliveryTime || 0) | number:'1.0-0' }} jours</h3>
                <p>Temps Moyen</p>
            </div>
        </div>
    </mat-card>

    <mat-card class="stat-card stat-teal">
        <div class="stat-content">
            <div class="stat-icon">
                <mat-icon>trending_up</mat-icon>
            </div>
            <div class="stat-details">
                <h3>{{ (stats().onTimeRate || 0) | number:'1.0-0' }}%</h3>
                <p>Taux à Temps</p>
            </div>
        </div>
    </mat-card>
</div>

<!-- Tracking Search -->
<mat-card class="tracking-card">
    <div class="card-header">
        <h2>
            <mat-icon>search</mat-icon>
            Suivre une livraison
        </h2>
    </div>
    <mat-divider></mat-divider>

    <form [formGroup]="trackingForm" class="tracking-form">
        <mat-form-field class="tracking-input">
            <mat-label>Numéro de suivi</mat-label>
            <input matInput formControlName="trackingNumber" placeholder="Ex: TRK1731234567ABC" />
            <mat-icon matPrefix>qr_code_scanner</mat-icon>
        </mat-form-field>
        <button mat-raised-button color="primary" (click)="trackDelivery()" [disabled]="trackingForm.invalid">
            <mat-icon>search</mat-icon>
            Rechercher
        </button>
    </form>
</mat-card>

<!-- Tabs -->
<mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="selectedTabIndex.set($event)"
    class="delivery-tabs">

    <!-- Tab 1: En Attente (PROCESSING - waiting for driver assignment) -->
    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">hourglass_empty</mat-icon>
            En Attente ({{ pendingDeliveries.length }})
        </ng-template>
        <div class="tab-content">
            <mat-card>
                <div class="card-header">
                    <h2>
                        <mat-icon>hourglass_empty</mat-icon>
                        Livraisons en attente d'assignation ({{ pendingDeliveries.length }})
                    </h2>
                </div>
                <mat-divider></mat-divider>

                <div class="table-container">
                    <table mat-table [dataSource]="pendingDeliveries" matSort>
                        <ng-container matColumnDef="trackingNumber">
                            <th mat-header-cell *matHeaderCellDef>Numéro de Suivi</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="tracking-cell">
                                    <mat-icon class="tracking-icon">qr_code</mat-icon>
                                    <strong>{{ delivery.trackingNumber }}</strong>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="order">
                            <th mat-header-cell *matHeaderCellDef>Commande</th>
                            <td mat-cell *matCellDef="let delivery">
                                {{ delivery.orderNumber }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="customer">
                            <th mat-header-cell *matHeaderCellDef>Client</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="customer-info">
                                    <strong>{{ delivery.customerName }}</strong>
                                    <span class="phone">{{ delivery.customerPhone }}</span>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="address">
                            <th mat-header-cell *matHeaderCellDef>Adresse</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="address-cell">
                                    <mat-icon>location_on</mat-icon>
                                    {{ delivery.address }}
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Statut</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="status-cell">
                                    <mat-chip [color]="getStatusColor(delivery.status)">
                                        <mat-icon>{{ getStatusIcon(delivery.status) }}</mat-icon>
                                        {{ getStatusLabel(delivery.status) }}
                                    </mat-chip>
                                    <mat-progress-bar mode="determinate" [value]="getDeliveryProgress(delivery.status)"
                                        [color]="getStatusColor(delivery.status)">
                                    </mat-progress-bar>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="courier">
                            <th mat-header-cell *matHeaderCellDef>Livreur</th>
                            <td mat-cell *matCellDef="let delivery">
                                <mat-form-field class="courier-select">
                                    <mat-select [value]="delivery.courierName"
                                        (selectionChange)="assignCourier(delivery.id, $event.value)">
                                        @for (courier of couriers; track courier) {
                                        <mat-option [value]="courier">{{ courier }}</mat-option>
                                        }
                                    </mat-select>
                                </mat-form-field>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="estimated">
                            <th mat-header-cell *matHeaderCellDef>Livraison Prévue</th>
                            <td mat-cell *matCellDef="let delivery">
                                {{ delivery.estimatedDelivery | date:'dd/MM/yyyy' }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let delivery">
                                <button mat-icon-button [matMenuTriggerFor]="actionMenu">
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                                <mat-menu #actionMenu="matMenu">
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'IN_TRANSIT')">
                                        <mat-icon>local_shipping</mat-icon>
                                        Marquer en transit
                                    </button>
                                    <button mat-menu-item
                                        (click)="updateDeliveryStatus(delivery.id, 'OUT_FOR_DELIVERY')">
                                        <mat-icon>delivery_dining</mat-icon>
                                        En cours de livraison
                                    </button>
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'DELIVERED')">
                                        <mat-icon>check_circle</mat-icon>
                                        Marquer comme livrée
                                    </button>
                                    <mat-divider></mat-divider>
                                    <button mat-menu-item (click)="printDeliveryLabel(delivery.id)">
                                        <mat-icon>print</mat-icon>
                                        Imprimer l'étiquette
                                    </button>
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'FAILED')">
                                        <mat-icon>error</mat-icon>
                                        Marquer comme échec
                                    </button>
                                </mat-menu>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="deliveryColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: deliveryColumns;"></tr>
                    </table>

                    <mat-paginator [pageSize]="pageSize()" [pageSizeOptions]="[5, 10, 25, 50]"
                        (page)="handlePageEvent($event)">
                    </mat-paginator>
                </div>
            </mat-card>
        </div>
    </mat-tab>

    <!-- Tab 2: En Cours (IN_TRANSIT - actively being delivered) -->
    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">local_shipping</mat-icon>
            En Cours ({{ activeDeliveries.length }})
        </ng-template>
        <div class="tab-content">
            <mat-card>
                <div class="card-header">
                    <h2>
                        <mat-icon>local_shipping</mat-icon>
                        Livraisons en cours de livraison ({{ activeDeliveries.length }})
                    </h2>
                </div>
                <mat-divider></mat-divider>

                <div class="table-container">
                    <table mat-table [dataSource]="activeDeliveries" matSort>
                        <ng-container matColumnDef="trackingNumber">
                            <th mat-header-cell *matHeaderCellDef>Numéro de Suivi</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="tracking-cell">
                                    <mat-icon class="tracking-icon">qr_code</mat-icon>
                                    <strong>{{ delivery.trackingNumber }}</strong>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="order">
                            <th mat-header-cell *matHeaderCellDef>Commande</th>
                            <td mat-cell *matCellDef="let delivery">
                                {{ delivery.orderNumber }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="customer">
                            <th mat-header-cell *matHeaderCellDef>Client</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="customer-info">
                                    <strong>{{ delivery.customerName }}</strong>
                                    <span class="phone">{{ delivery.customerPhone }}</span>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="address">
                            <th mat-header-cell *matHeaderCellDef>Adresse</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="address-cell">
                                    <mat-icon>location_on</mat-icon>
                                    {{ delivery.address }}
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Statut</th>
                            <td mat-cell *matCellDef="let delivery">
                                <mat-chip [color]="getStatusColor(delivery.status)">
                                    <mat-icon>{{ getStatusIcon(delivery.status) }}</mat-icon>
                                    {{ getStatusLabel(delivery.status) }}
                                </mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="courier">
                            <th mat-header-cell *matHeaderCellDef>Livreur</th>
                            <td mat-cell *matCellDef="let delivery">
                                {{ delivery.courierName }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="estimated">
                            <th mat-header-cell *matHeaderCellDef>Date</th>
                            <td mat-cell *matCellDef="let delivery">
                                @if (delivery.actualDelivery) {
                                <div class="date-cell">
                                    <strong>{{ delivery.actualDelivery | date:'dd/MM/yyyy' }}</strong>
                                    <span class="label">Livrée</span>
                                </div>
                                } @else {
                                <div class="date-cell">
                                    {{ delivery.estimatedDelivery | date:'dd/MM/yyyy' }}
                                    <span class="label">Prévue</span>
                                </div>
                                }
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let delivery">
                                <button mat-icon-button matTooltip="Voir les détails"
                                    (click)="viewDeliveryDetails(delivery)">
                                    <mat-icon>visibility</mat-icon>
                                </button>
                                <button mat-icon-button matTooltip="Suivre sur carte" (click)="trackOnMap(delivery)">
                                    <mat-icon>map</mat-icon>
                                </button>
                                <button mat-icon-button [matMenuTriggerFor]="statusMenu" matTooltip="Changer statut">
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                                <mat-menu #statusMenu="matMenu">
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'PROCESSING')">
                                        <mat-icon>hourglass_empty</mat-icon>
                                        En préparation
                                    </button>
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'IN_TRANSIT')">
                                        <mat-icon>local_shipping</mat-icon>
                                        Marquer en transit
                                    </button>
                                    <button mat-menu-item
                                        (click)="updateDeliveryStatus(delivery.id, 'OUT_FOR_DELIVERY')">
                                        <mat-icon>delivery_dining</mat-icon>
                                        En cours de livraison
                                    </button>
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'DELIVERED')">
                                        <mat-icon>check_circle</mat-icon>
                                        Marquer comme livrée
                                    </button>
                                    <mat-divider></mat-divider>
                                    <button mat-menu-item (click)="updateDeliveryStatus(delivery.id, 'FAILED')">
                                        <mat-icon>error</mat-icon>
                                        Marquer comme échec
                                    </button>
                                </mat-menu>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="deliveryColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: deliveryColumns;"></tr>
                    </table>

                    <mat-paginator [pageSize]="pageSize()" [pageSizeOptions]="[5, 10, 25, 50]"
                        (page)="handlePageEvent($event)">
                    </mat-paginator>
                </div>
            </mat-card>
        </div>
    </mat-tab>

    <!-- Tab 3: Historique (DELIVERED - completed) -->
    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">check_circle</mat-icon>
            Historique ({{ completedDeliveries.length }})
        </ng-template>
        <div class="tab-content">
            <mat-card>
                <div class="card-header">
                    <h2>
                        <mat-icon>check_circle</mat-icon>
                        Livraisons terminées ({{ completedDeliveries.length }})
                    </h2>
                </div>
                <mat-divider></mat-divider>

                <div class="table-container" *ngIf="completedDeliveries.length > 0">
                    <table mat-table [dataSource]="completedDeliveries" matSort>
                        <ng-container matColumnDef="trackingNumber">
                            <th mat-header-cell *matHeaderCellDef>Numéro de Suivi</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="tracking-cell">
                                    <mat-icon class="tracking-icon success">qr_code</mat-icon>
                                    <strong>{{ delivery.trackingNumber }}</strong>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="order">
                            <th mat-header-cell *matHeaderCellDef>Commande</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.orderNumber || delivery.order?.id }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="customer">
                            <th mat-header-cell *matHeaderCellDef>Client</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.deliveryNotes || '-' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="address">
                            <th mat-header-cell *matHeaderCellDef>Adresse</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.address }}</td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Statut</th>
                            <td mat-cell *matCellDef="let delivery">
                                <mat-chip color="primary">
                                    <mat-icon>check_circle</mat-icon>
                                    Livré
                                </mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="courier">
                            <th mat-header-cell *matHeaderCellDef>Livreur</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.driverName || '-' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="estimated">
                            <th mat-header-cell *matHeaderCellDef>Date Livraison</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.actualDelivery | date:'short' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let delivery">
                                <button mat-icon-button (click)="viewDeliveryDetails(delivery)">
                                    <mat-icon>visibility</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="deliveryColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: deliveryColumns;"></tr>
                    </table>
                </div>

                <div *ngIf="completedDeliveries.length === 0" class="empty-state">
                    <mat-icon>check_circle_outline</mat-icon>
                    <p>Aucune livraison terminée</p>
                </div>
            </mat-card>
        </div>
    </mat-tab>

    <!-- Tab 4: Échecs (FAILED, CANCELLED) -->
    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">error</mat-icon>
            Échecs ({{ failedDeliveries.length }})
        </ng-template>
        <div class="tab-content">
            <mat-card>
                <div class="card-header">
                    <h2>
                        <mat-icon color="warn">error</mat-icon>
                        Livraisons échouées ({{ failedDeliveries.length }})
                    </h2>
                </div>
                <mat-divider></mat-divider>

                <div class="table-container" *ngIf="failedDeliveries.length > 0">
                    <table mat-table [dataSource]="failedDeliveries" matSort>
                        <ng-container matColumnDef="trackingNumber">
                            <th mat-header-cell *matHeaderCellDef>Numéro de Suivi</th>
                            <td mat-cell *matCellDef="let delivery">
                                <div class="tracking-cell">
                                    <mat-icon class="tracking-icon error">qr_code</mat-icon>
                                    <strong>{{ delivery.trackingNumber }}</strong>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="order">
                            <th mat-header-cell *matHeaderCellDef>Commande</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.orderNumber || delivery.order?.id }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="customer">
                            <th mat-header-cell *matHeaderCellDef>Client</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.deliveryNotes || '-' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="address">
                            <th mat-header-cell *matHeaderCellDef>Adresse</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.address }}</td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Statut</th>
                            <td mat-cell *matCellDef="let delivery">
                                <mat-chip color="warn">
                                    <mat-icon>error</mat-icon>
                                    {{ getStatusLabel(delivery.status) }}
                                </mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="courier">
                            <th mat-header-cell *matHeaderCellDef>Livreur</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.driverName || '-' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="estimated">
                            <th mat-header-cell *matHeaderCellDef>Notes</th>
                            <td mat-cell *matCellDef="let delivery">{{ delivery.notes || '-' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let delivery">
                                <button mat-icon-button (click)="viewDeliveryDetails(delivery)" matTooltip="Détails">
                                    <mat-icon>visibility</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="deliveryColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: deliveryColumns;"></tr>
                    </table>
                </div>

                <div *ngIf="failedDeliveries.length === 0" class="empty-state">
                    <mat-icon>sentiment_satisfied</mat-icon>
                    <p>Aucune livraison échouée</p>
                </div>
            </mat-card>
        </div>
    </mat-tab>
</mat-tab-group>