<!-- ========================================================== -->
<!-- WORLD-CLASS ORDER DETAILS - Premium Enterprise UI -->
<!-- Matching the Orders Management design system -->
<!-- ========================================================== -->

<div class="order-details-container">
    @if (loading()) {
    <div class="loading-state">
        <mat-spinner diameter="48"></mat-spinner>
        <p>Chargement de la commande...</p>
    </div>
    } @else if (order()) {

    <!-- Premium Floating Header -->
    <header class="details-header">
        <div class="header-left">
            <button class="back-btn" (click)="goBack()" matTooltip="Retour aux commandes">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <div class="page-title-section">
                <div class="title-badge" [class]="order()!.status?.toLowerCase()">
                    <mat-icon>{{ getStatusIcon(order()!.status) }}</mat-icon>
                </div>
                <div class="title-content">
                    <h1>Commande #{{ order()!.id?.substring(0, 8) }}</h1>
                    <p class="breadcrumb">
                        Créée le {{ order()!.createdAt | date:'dd MMMM yyyy à HH:mm' }}
                    </p>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="status-badge" [class]="order()!.status?.toLowerCase()">
                <span class="status-dot"></span>
                {{ getStatusLabel(order()!.status) }}
            </div>
            <div class="header-actions">
                <button class="btn-icon" matTooltip="Imprimer" (click)="printInvoice()">
                    <mat-icon>print</mat-icon>
                </button>
                <button class="btn-icon" matTooltip="Télécharger PDF" (click)="downloadInvoice()">
                    <mat-icon>download</mat-icon>
                </button>
                @if (order()!.status !== 'REFUNDED' && order()!.status !== 'CANCELLED') {
                <button class="btn-danger" (click)="processRefund()">
                    <mat-icon>money_off</mat-icon>
                    <span>Rembourser</span>
                </button>
                }
            </div>
        </div>
    </header>

    <!-- Quick Stats Bar -->
    <section class="quick-stats-bar">
        <div class="stat-card">
            <div class="stat-icon items">
                <mat-icon>shopping_bag</mat-icon>
            </div>
            <div class="stat-info">
                <span class="value">{{ order()!.orderItems?.length || 0 }}</span>
                <span class="label">Articles</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon total">
                <mat-icon>payments</mat-icon>
            </div>
            <div class="stat-info">
                <span class="value">{{ order()!.totalPrice | number:'1.2-2' }} <small>TND</small></span>
                <span class="label">Total</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon customer">
                <mat-icon>person</mat-icon>
            </div>
            <div class="stat-info">
                <span class="value">{{ order()!.user?.fullName || order()!.user?.username || 'Client' }}</span>
                <span class="label">Client</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon date">
                <mat-icon>schedule</mat-icon>
            </div>
            <div class="stat-info">
                <span class="value">{{ order()!.createdAt | date:'dd MMM yyyy' }}</span>
                <span class="label">Date de commande</span>
            </div>
        </div>
    </section>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left Column - Order Items -->
        <div class="left-column">
            <!-- Order Items Card -->
            <div class="premium-card items-card">
                <div class="card-header">
                    <div class="header-info">
                        <mat-icon>inventory_2</mat-icon>
                        <h3>Articles commandés</h3>
                    </div>
                    <span class="item-count">{{ order()!.orderItems?.length || 0 }} article(s)</span>
                </div>
                <div class="card-body">
                    <div class="items-list">
                        @for (item of order()!.orderItems || []; track item.id) {
                        <div class="item-row">
                            <div class="item-image">
                                @if (item.product?.imageUrl) {
                                <img [src]="item.product.imageUrl" [alt]="item.product?.name">
                                } @else {
                                <div class="image-placeholder">
                                    <mat-icon>image</mat-icon>
                                </div>
                                }
                            </div>
                            <div class="item-details">
                                <h4>{{ item.product?.name || 'Produit' }}</h4>
                                <p class="item-sku">SKU: {{ item.product?.sku || 'N/A' }}</p>
                            </div>
                            <div class="item-quantity">
                                <span class="qty-badge">× {{ item.quantity }}</span>
                            </div>
                            <div class="item-price">
                                <span class="unit-price">{{ item.price | number:'1.2-2' }} TND</span>
                            </div>
                            <div class="item-total">
                                <span class="total-price">{{ getItemTotal(item) | number:'1.2-2' }} TND</span>
                            </div>
                        </div>
                        }
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Sous-total</span>
                            <span>{{ order()!.totalPrice | number:'1.2-2' }} TND</span>
                        </div>
                        <div class="summary-row">
                            <span>Livraison</span>
                            <span class="free-shipping">Gratuite</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span class="total-amount">{{ order()!.totalPrice | number:'1.2-2' }}
                                <small>TND</small></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Timeline Card -->
            <div class="premium-card timeline-card">
                <div class="card-header">
                    <div class="header-info">
                        <mat-icon>history</mat-icon>
                        <h3>Historique de la commande</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item active">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4>Commande créée</h4>
                                    <span class="timeline-date">{{ formatDate(order()!.createdAt) }}</span>
                                </div>
                                <p>La commande a été passée avec succès</p>
                            </div>
                        </div>
                        @if (order()!.status === 'CONFIRMED' || order()!.status === 'SHIPPED' || order()!.status ===
                        'DELIVERED') {
                        <div class="timeline-item active">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4>Commande confirmée</h4>
                                </div>
                                <p>La commande a été validée pour traitement</p>
                            </div>
                        </div>
                        }
                        @if (order()!.status === 'SHIPPED' || order()!.status === 'DELIVERED') {
                        <div class="timeline-item active">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4>Expédiée</h4>
                                </div>
                                <p>La commande a été remise au transporteur</p>
                            </div>
                        </div>
                        }
                        @if (order()!.status === 'DELIVERED') {
                        <div class="timeline-item active completed">
                            <div class="timeline-dot">
                                <mat-icon>check</mat-icon>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4>Livrée</h4>
                                </div>
                                <p>La commande a été livrée avec succès</p>
                            </div>
                        </div>
                        }
                        @if (order()!.status === 'CANCELLED') {
                        <div class="timeline-item cancelled">
                            <div class="timeline-dot">
                                <mat-icon>close</mat-icon>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4>Annulée</h4>
                                </div>
                                <p>La commande a été annulée</p>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Side Cards -->
        <div class="right-column">
            <!-- Status Management Card -->
            <div class="premium-card status-card">
                <div class="card-header">
                    <div class="header-info">
                        <mat-icon>tune</mat-icon>
                        <h3>Gestion du statut</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="status-selector">
                        <label>Modifier le statut</label>
                        <div class="status-dropdown" [class]="order()!.status?.toLowerCase()">
                            <select [value]="order()!.status" (change)="updateOrderStatus($any($event.target).value)">
                                @for (status of statusOptions; track status) {
                                <option [value]="status">{{ getStatusLabel(status) }}</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Information Card -->
            <div class="premium-card customer-card">
                <div class="card-header">
                    <div class="header-info">
                        <mat-icon>person</mat-icon>
                        <h3>Informations client</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="customer-profile">
                        <div class="customer-avatar">
                            {{ getCustomerInitials() }}
                        </div>
                        <div class="customer-details">
                            <h4>{{ order()!.user?.fullName || order()!.user?.username || 'Client' }}</h4>
                            <span class="customer-since">Client depuis 2024</span>
                        </div>
                    </div>
                    <div class="info-list">
                        <div class="info-item">
                            <mat-icon>email</mat-icon>
                            <div class="info-content">
                                <label>Email</label>
                                <span>{{ order()!.user?.email || 'Non renseigné' }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <mat-icon>phone</mat-icon>
                            <div class="info-content">
                                <label>Téléphone</label>
                                <span>{{ order()!.user?.phone || 'Non renseigné' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Address Card -->
            <div class="premium-card address-card">
                <div class="card-header">
                    <div class="header-info">
                        <mat-icon>local_shipping</mat-icon>
                        <h3>Adresse de livraison</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="address-box">
                        <mat-icon>location_on</mat-icon>
                        <div class="address-content">
                            <p>{{ order()!.shippingAddress || order()!.user?.address || 'Adresse non renseignée' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Information Card -->
            <div class="premium-card payment-card">
                <div class="card-header">
                    <div class="header-info">
                        <mat-icon>payment</mat-icon>
                        <h3>Paiement</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="payment-method">
                        <div class="method-icon">
                            <mat-icon>credit_card</mat-icon>
                        </div>
                        <div class="method-details">
                            <span class="method-name">Carte bancaire</span>
                            <span class="method-status"
                                [class]="order()!.status === 'PAID' || order()!.status === 'DELIVERED' ? 'paid' : 'pending'">
                                {{ order()!.status === 'PAID' || order()!.status === 'DELIVERED' ? 'Payé' : 'En attente'
                                }}
                            </span>
                        </div>
                    </div>
                    <div class="payment-summary">
                        <div class="payment-row">
                            <span>Montant</span>
                            <span class="amount">{{ order()!.totalPrice | number:'1.2-2' }} TND</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>