<mat-card>
    <div class="card-header">
        <h2>
            <mat-icon>receipt_long</mat-icon>
            Gestion des commandes ({{ orders().length }})
        </h2>
    </div>

    <mat-divider></mat-divider>

    <div class="table-container">
        <table mat-table [dataSource]="orders()" matSort (matSortChange)="handleSort($event)">

            <!-- Order Number Column -->
            <ng-container matColumnDef="orderNumber">
                <th mat-header-cell *matHeaderCellDef>Numéro</th>
                <td mat-cell *matCellDef="let order">
                    <span matTooltip="{{ order.id }}">#{{ order.id | slice:0:8 }}</span>
                </td>
            </ng-container>

            <!-- Customer Column -->
            <ng-container matColumnDef="customer">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Client</th>
                <td mat-cell *matCellDef="let order">
                    <div class="customer-info">
                        <strong>{{ order.user?.fullName || order.user?.username }}</strong>
                        <span class="customer-email">{{ order.user?.email }}</span>
                    </div>
                </td>
            </ng-container>

            <!-- Date Column -->
            <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                <td mat-cell *matCellDef="let order">
                    {{ order.createdAt | date:'dd/MM/yyyy HH:mm' }}
                </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Statut</th>
                <td mat-cell *matCellDef="let order">
                    <mat-form-field class="status-select" subscriptSizing="dynamic">
                        <mat-select [value]="order.status"
                            (selectionChange)="updateOrderStatus(order.id, $event.value)">
                            <mat-option value="PENDING">En attente</mat-option>
                            <mat-option value="CONFIRMED">Confirmée</mat-option>
                            <mat-option value="SHIPPED">Expédiée</mat-option>
                            <mat-option value="DELIVERED">Livrée</mat-option>
                            <mat-option value="CANCELLED">Annulée</mat-option>
                        </mat-select>
                    </mat-form-field>
                </td>
            </ng-container>

            <!-- Items Column -->
            <ng-container matColumnDef="items">
                <th mat-header-cell *matHeaderCellDef>Articles</th>
                <td mat-cell *matCellDef="let order">
                    {{ order.orderItems?.length || 0 }} article(s)
                </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
                <td mat-cell *matCellDef="let order">
                    <strong class="total-amount">{{ order.totalPrice | number:'1.2-2' }} TND</strong>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="primary" (click)="viewOrderDetails(order.id)"
                        matTooltip="Voir les détails">
                        <mat-icon>visibility</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="orderColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: orderColumns;"></tr>
        </table>

        <mat-paginator [pageSize]="pageSize()" [pageSizeOptions]="[5, 10, 25, 50]" (page)="handlePageEvent($event)">
        </mat-paginator>
    </div>
</mat-card>