<div class="profile-page">
    <!-- Hidden file input -->
    <input type="file" #fileInput hidden accept="image/*" (change)="onFileSelected($event)">

    <!-- Premium Header -->
    <header class="profile-header">
        <div class="header-bg"></div>
        <div class="header-content">
            <div class="user-avatar" (click)="triggerFileInput()">
                <div class="avatar-ring"></div>
                <div class="avatar-inner" [class.has-image]="currentUser()?.profilePicture">
                    @if (currentUser()?.profilePicture) {
                    <img [src]="currentUser()?.profilePicture" alt="Photo de profil">
                    } @else {
                    <mat-icon>person</mat-icon>
                    }
                    @if (uploadingPicture()) {
                    <div class="upload-overlay">
                        <mat-spinner diameter="32"></mat-spinner>
                    </div>
                    } @else {
                    <div class="upload-hint">
                        <mat-icon>photo_camera</mat-icon>
                    </div>
                    }
                </div>
            </div>
            <div class="user-details">
                <h1>{{ fullName() }}</h1>
                <p class="user-email">{{ currentUser()?.email }}</p>
            </div>
            <button class="logout-btn" (click)="logout()">
                <mat-icon>logout</mat-icon>
                <span>Déconnexion</span>
            </button>
        </div>
    </header>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <mat-icon>shopping_bag</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ orderStats().total }}</span>
                    <span class="stat-label">Commandes totales</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon pending">
                    <mat-icon>schedule</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ orderStats().pending }}</span>
                    <span class="stat-label">En cours</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <mat-icon>check_circle</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ orderStats().delivered }}</span>
                    <span class="stat-label">Livrées</span>
                </div>
            </div>

            <div class="stat-card highlight">
                <div class="stat-icon">
                    <mat-icon>account_balance_wallet</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ orderStats().totalSpent | number:'1.0-0' }} <small>TND</small></span>
                    <span class="stat-label">Total dépensé</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="main-content">
        <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="selectedTabIndex.set($event)"
            class="premium-tabs">

            <!-- Profile Info Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon>person</mat-icon>
                    <span>Informations</span>
                </ng-template>

                <div class="tab-content">
                    <!-- Personal Info Card -->
                    <div class="content-card">
                        <div class="card-header">
                            <div class="header-left">
                                <div class="header-icon">
                                    <mat-icon>badge</mat-icon>
                                </div>
                                <div class="header-text">
                                    <h2>Mes informations</h2>
                                    <p>Gérez vos données personnelles</p>
                                </div>
                            </div>
                            @if (!editingProfile()) {
                            <button class="edit-btn" (click)="toggleEditProfile()">
                                <mat-icon>edit</mat-icon>
                                <span>Modifier</span>
                            </button>
                            }
                        </div>

                        @if (!editingProfile()) {
                        <!-- View Mode -->
                        <div class="info-list">
                            <div class="info-item">
                                <div class="item-label">
                                    <mat-icon>person</mat-icon>
                                    <span>Prénom</span>
                                </div>
                                <span class="item-value">{{ currentUser()?.firstName }}</span>
                            </div>

                            <div class="info-item">
                                <div class="item-label">
                                    <mat-icon>person_outline</mat-icon>
                                    <span>Nom</span>
                                </div>
                                <span class="item-value">{{ currentUser()?.lastName }}</span>
                            </div>

                            <div class="info-item">
                                <div class="item-label">
                                    <mat-icon>email</mat-icon>
                                    <span>Email</span>
                                </div>
                                <span class="item-value">{{ currentUser()?.email }}</span>
                            </div>

                            <div class="info-item">
                                <div class="item-label">
                                    <mat-icon>phone</mat-icon>
                                    <span>Téléphone</span>
                                </div>
                                <span class="item-value">{{ currentUser()?.phoneNumber || 'Non renseigné' }}</span>
                            </div>

                            @if (currentUser()?.provider === 'GOOGLE') {
                            <div class="info-item">
                                <div class="item-label">
                                    <mat-icon>login</mat-icon>
                                    <span>Connexion</span>
                                </div>
                                <span class="item-value">
                                    <span class="google-badge">
                                        <mat-icon>g_translate</mat-icon>
                                        Google
                                    </span>
                                </span>
                            </div>
                            }
                        </div>
                        } @else {
                        <!-- Edit Mode -->
                        <form [formGroup]="profileForm" class="edit-form">
                            <div class="form-row">
                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Prénom</mat-label>
                                    <input matInput formControlName="firstName" />
                                    <mat-icon matPrefix>person</mat-icon>
                                    @if (profileForm.get('firstName')?.hasError('required') &&
                                    profileForm.get('firstName')?.touched) {
                                    <mat-error>Le prénom est requis</mat-error>
                                    }
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Nom</mat-label>
                                    <input matInput formControlName="lastName" />
                                    <mat-icon matPrefix>person_outline</mat-icon>
                                    @if (profileForm.get('lastName')?.hasError('required') &&
                                    profileForm.get('lastName')?.touched) {
                                    <mat-error>Le nom est requis</mat-error>
                                    }
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Email</mat-label>
                                <input matInput type="email" formControlName="email" />
                                <mat-icon matPrefix>email</mat-icon>
                                @if (profileForm.get('email')?.disabled) {
                                <mat-hint>Email Google non modifiable</mat-hint>
                                }
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Téléphone</mat-label>
                                <input matInput formControlName="phoneNumber" placeholder="06XXXXXXXX" />
                                <mat-icon matPrefix>phone</mat-icon>
                            </mat-form-field>

                            <div class="form-actions">
                                <button type="button" class="btn-secondary" (click)="toggleEditProfile()">
                                    Annuler
                                </button>
                                <button type="button" class="btn-primary" (click)="saveProfile()"
                                    [disabled]="profileForm.invalid || loading()">
                                    @if (loading()) {
                                    <mat-spinner diameter="18"></mat-spinner>
                                    }
                                    <span>Enregistrer</span>
                                </button>
                            </div>
                        </form>
                        }
                    </div>

                    <!-- Password Card -->
                    @if (currentUser()?.provider !== 'GOOGLE') {
                    <div class="content-card">
                        <div class="card-header">
                            <div class="header-left">
                                <div class="header-icon">
                                    <mat-icon>lock</mat-icon>
                                </div>
                                <div class="header-text">
                                    <h2>Mot de passe</h2>
                                    <p>Sécurisez votre compte</p>
                                </div>
                            </div>
                        </div>

                        <form [formGroup]="passwordForm" class="edit-form">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Mot de passe actuel</mat-label>
                                <input matInput type="password" formControlName="currentPassword" />
                                <mat-icon matPrefix>lock_open</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Nouveau mot de passe</mat-label>
                                <input matInput type="password" formControlName="newPassword" />
                                <mat-icon matPrefix>lock</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Confirmer le mot de passe</mat-label>
                                <input matInput type="password" formControlName="confirmPassword" />
                                <mat-icon matPrefix>lock_outline</mat-icon>
                                @if (passwordForm.hasError('passwordMismatch') &&
                                passwordForm.get('confirmPassword')?.touched) {
                                <mat-error>Les mots de passe ne correspondent pas</mat-error>
                                }
                            </mat-form-field>

                            <div class="form-actions">
                                <button type="button" class="btn-primary" (click)="changePassword()"
                                    [disabled]="passwordForm.invalid || loading()">
                                    @if (loading()) {
                                    <mat-spinner diameter="18"></mat-spinner>
                                    }
                                    <span>Changer le mot de passe</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    }
                </div>
            </mat-tab>

            <!-- Orders Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon>receipt_long</mat-icon>
                    <span>Commandes</span>
                </ng-template>

                <div class="tab-content">
                    @if (!showOrderDetails()) {
                    <!-- Orders List View -->
                    <div class="content-card">
                        <div class="card-header">
                            <div class="header-left">
                                <div class="header-icon">
                                    <mat-icon>inventory_2</mat-icon>
                                </div>
                                <div class="header-text">
                                    <h2>Historique des commandes</h2>
                                    <p>Suivez toutes vos commandes</p>
                                </div>
                            </div>
                        </div>

                        @if (loadingOrders()) {
                        <div class="loading-state">
                            <mat-spinner diameter="40"></mat-spinner>
                            <p>Chargement des commandes...</p>
                        </div>
                        } @else if (orders().length > 0) {
                        <div class="orders-list">
                            @for (order of orders(); track order.id) {
                            <div class="order-item" (click)="viewOrderDetails(order)">
                                <div class="order-main">
                                    <div class="order-info">
                                        <span class="order-number">{{ order.orderNumber || 'CMD-' +
                                            order.id.substring(0, 8) }}</span>
                                        <span class="order-date">{{ order.createdAt | date:'dd MMM yyyy' }}</span>
                                    </div>
                                    <div class="order-meta">
                                        <span class="order-items">{{ order.orderItems?.length || 0 }} article(s)</span>
                                        <span class="order-status" [class]="getStatusColor(order.status)">
                                            {{ getStatusLabel(order.status) }}
                                        </span>
                                    </div>
                                </div>
                                <div class="order-end">
                                    <span class="order-total">{{ order.totalPrice | number:'1.2-2' }} TND</span>
                                    @if (canTrackOrder(order)) {
                                    <button class="track-order-btn"
                                        (click)="trackOrder(order); $event.stopPropagation()"
                                        title="Suivre ma livraison">
                                        <mat-icon>local_shipping</mat-icon>
                                    </button>
                                    }
                                    <button class="view-btn">
                                        <mat-icon>arrow_forward</mat-icon>
                                    </button>
                                </div>
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="empty-state">
                            <div class="empty-icon">
                                <mat-icon>shopping_bag</mat-icon>
                            </div>
                            <h3>Aucune commande</h3>
                            <p>Vous n'avez pas encore passé de commande</p>
                            <a routerLink="/products" class="btn-primary">
                                Découvrir nos produits
                            </a>
                        </div>
                        }
                    </div>
                    } @else {
                    <!-- Order Details View -->
                    @if (selectedOrder(); as order) {
                    <div class="order-details-card">
                        <div class="details-header">
                            <button class="back-btn" (click)="closeOrderDetails()">
                                <mat-icon>arrow_back</mat-icon>
                                <span>Retour</span>
                            </button>
                            <div class="order-title">
                                <h2>{{ order.orderNumber || 'CMD-' + order.id.substring(0, 8) }}</h2>
                                <span class="order-status large" [class]="getStatusColor(order.status)">
                                    {{ getStatusLabel(order.status) }}
                                </span>
                            </div>
                        </div>

                        <!-- Order Info -->
                        <div class="details-section">
                            <h3>Informations</h3>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Date de commande</span>
                                    <span class="detail-value">{{ order.createdAt | date:'dd MMMM yyyy à HH:mm'
                                        }}</span>
                                </div>
                                @if (order.trackingNumber) {
                                <div class="detail-item">
                                    <span class="detail-label">Numéro de suivi</span>
                                    <span class="detail-value tracking">{{ order.trackingNumber }}</span>
                                </div>
                                }
                                @if (order.shippingAddress) {
                                <div class="detail-item">
                                    <span class="detail-label">Adresse de livraison</span>
                                    <span class="detail-value">
                                        {{ order.shippingAddress.street }}, {{ order.shippingAddress.city }} {{
                                        order.shippingAddress.postalCode }}
                                    </span>
                                </div>
                                }
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="details-section">
                            <h3>Articles commandés</h3>
                            <div class="order-items-list">
                                @for (item of order.orderItems; track item.id) {
                                <div class="order-product">
                                    <div class="product-image">
                                        <img [src]="item.product?.imageUrl || 'https://via.placeholder.com/80'"
                                            [alt]="item.product?.name">
                                    </div>
                                    <div class="product-info">
                                        <span class="product-name">{{ item.product?.name || 'Produit' }}</span>
                                        <span class="product-sku">{{ item.product?.sku || '' }}</span>
                                        <span class="product-qty">Quantité: {{ item.quantity }}</span>
                                    </div>
                                    <div class="product-price">
                                        <span class="unit-price">{{ item.price | number:'1.2-2' }} TND</span>
                                        <span class="subtotal">{{ (item.price * item.quantity) | number:'1.2-2' }}
                                            TND</span>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>

                        <!-- Order Total -->
                        <div class="details-section total-section">
                            <div class="total-row">
                                <span>Total</span>
                                <span class="total-amount">{{ order.totalPrice | number:'1.2-2' }} TND</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="details-actions">
                            @if (canTrackOrder(order)) {
                            <button class="btn-primary track-btn" (click)="trackOrder(order)">
                                <mat-icon>local_shipping</mat-icon>
                                <span>Suivre ma livraison</span>
                            </button>
                            }
                            @if (canCancelOrder(order)) {
                            <button class="btn-danger" (click)="cancelOrder(order.id)">
                                <mat-icon>cancel</mat-icon>
                                <span>Annuler la commande</span>
                            </button>
                            }
                        </div>
                    </div>
                    }
                    }
                </div>
            </mat-tab>

            <!-- Addresses Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon>location_on</mat-icon>
                    <span>Adresses</span>
                </ng-template>

                <div class="tab-content">
                    <!-- Existing Addresses -->
                    @if (addresses().length > 0) {
                    <div class="addresses-grid">
                        @for (address of addresses(); track address.id) {
                        <div class="address-card">
                            <div class="address-header">
                                <mat-icon>home</mat-icon>
                                <div class="address-actions">
                                    <button class="action-btn" (click)="editAddress(address)" matTooltip="Modifier">
                                        <mat-icon>edit</mat-icon>
                                    </button>
                                    <button class="action-btn danger" (click)="deleteAddress(address.id!)"
                                        matTooltip="Supprimer">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                            </div>
                            <div class="address-body">
                                <p class="street">{{ address.street }}</p>
                                <p class="city">{{ address.city }}, {{ address.postalCode }}</p>
                                <p class="country">{{ address.country }}</p>
                            </div>
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-state small">
                        <mat-icon>location_off</mat-icon>
                        <p>Aucune adresse enregistrée</p>
                    </div>
                    }

                    <!-- Add/Edit Address Form -->
                    <div class="content-card">
                        <div class="card-header">
                            <div class="header-left">
                                <div class="header-icon">
                                    <mat-icon>{{ editingAddress() ? 'edit_location' : 'add_location' }}</mat-icon>
                                </div>
                                <div class="header-text">
                                    <h2>{{ editingAddress() ? 'Modifier l\'adresse' : 'Ajouter une adresse' }}</h2>
                                    <p>Facilitez vos prochaines commandes</p>
                                </div>
                            </div>
                        </div>

                        <form [formGroup]="addressForm" class="edit-form">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Rue et numéro</mat-label>
                                <input matInput formControlName="street" />
                                <mat-icon matPrefix>home</mat-icon>
                            </mat-form-field>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Ville</mat-label>
                                    <input matInput formControlName="city" />
                                    <mat-icon matPrefix>location_city</mat-icon>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Code postal</mat-label>
                                    <input matInput formControlName="postalCode" placeholder="1000" />
                                    <mat-icon matPrefix>markunread_mailbox</mat-icon>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Pays</mat-label>
                                <input matInput formControlName="country" readonly />
                                <mat-icon matPrefix>flag</mat-icon>
                            </mat-form-field>

                            <div class="form-actions">
                                @if (editingAddress()) {
                                <button type="button" class="btn-secondary" (click)="cancelAddressEdit()">
                                    Annuler
                                </button>
                                <button type="button" class="btn-primary" (click)="updateAddress()"
                                    [disabled]="addressForm.invalid">
                                    <mat-icon>save</mat-icon>
                                    <span>Mettre à jour</span>
                                </button>
                                } @else {
                                <button type="button" class="btn-primary" (click)="addAddress()"
                                    [disabled]="addressForm.invalid">
                                    <mat-icon>add</mat-icon>
                                    <span>Ajouter l'adresse</span>
                                </button>
                                }
                            </div>
                        </form>
                    </div>
                </div>
            </mat-tab>

        </mat-tab-group>
    </section>
</div>