<div class="chat-page">
    <!-- Main Layout -->
    <div class="chat-layout">
        <!-- Conversations Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="header-top">
                    <h2>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                        </svg>
                        Conversations
                    </h2>
                    <button class="refresh-btn" (click)="refresh()" [class.spinning]="loading()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                        </svg>
                    </button>
                </div>
                <div class="search-box">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    <input type="text" placeholder="Rechercher une conversation...">
                </div>
            </div>

            <div class="conversations-list">
                @if (loading()) {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Chargement...</p>
                </div>
                } @else if (conversations().length === 0) {
                <div class="empty-state">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                    </svg>
                    <p>Aucune conversation</p>
                    <span>Les nouvelles demandes apparaîtront ici</span>
                </div>
                } @else {
                @for (conv of conversations(); track conv.id) {
                <div class="conversation-item" [class.active]="selectedConversation()?.id === conv.id"
                    [class.unread]="conv.unreadCount && conv.unreadCount > 0" (click)="selectConversation(conv)">
                    <div class="conv-avatar">
                        {{ getConvInitials(conv) }}
                        <span class="status-dot online"></span>
                    </div>
                    <div class="conv-content">
                        <div class="conv-header">
                            <span class="conv-name">{{ conv.title || 'Client #' + conv.id?.slice(0, 6) }}</span>
                            <span class="conv-time">{{ formatDate(conv.updatedAt) }}</span>
                        </div>
                        <div class="conv-preview">
                            {{ conv.lastMessage?.content || 'Nouvelle conversation' }}
                        </div>
                    </div>
                    @if (conv.unreadCount && conv.unreadCount > 0) {
                    <span class="unread-badge">{{ conv.unreadCount }}</span>
                    }
                </div>
                }
                }
            </div>
        </aside>

        <!-- Chat Window -->
        <main class="chat-main">
            @if (!selectedConversation()) {
            <div class="no-conversation">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                </svg>
                <h2>Support Client</h2>
                <p>Sélectionnez une conversation dans la liste pour commencer à répondre aux demandes des clients.</p>
            </div>
            } @else {
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-info">
                    <div class="avatar">
                        {{ getConvInitials(selectedConversation()) }}
                    </div>
                    <div class="chat-title">
                        <h3>{{ selectedConversation()?.title || 'Conversation' }}</h3>
                        <p class="status">
                            <span class="status-indicator"></span>
                            ID: {{ selectedConversation()?.userId?.slice(0, 8) }}...
                        </p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn" title="Marquer comme résolu">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
                        </svg>
                    </button>
                    <button class="action-btn" title="Plus d'options">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" #messagesContainer>
                <div class="messages-list">
                    @for (msg of messages(); track msg.id) {
                    <div class="message" [class.own]="isOwnMessage(msg)" [class.customer]="!isOwnMessage(msg)">
                        @if (!isOwnMessage(msg)) {
                        <div class="message-avatar">
                            {{ getConvInitials(selectedConversation()) }}
                        </div>
                        }
                        <div class="message-bubble">
                            <p class="message-text">{{ msg.content }}</p>
                            <span class="message-time">{{ formatTime(msg.createdAt) }}</span>
                        </div>
                    </div>
                    }
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <button class="attach-btn" title="Joindre un fichier">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
                    </svg>
                </button>
                <div class="input-wrapper">
                    <input type="text" [(ngModel)]="newMessage" placeholder="Écrivez votre réponse..."
                        (keyup.enter)="sendMessage()">
                </div>
                <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage.trim() || sending()">
                    @if (sending()) {
                    <div class="btn-spinner"></div>
                    } @else {
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                    }
                </button>
            </div>
            }
        </main>
    </div>
</div>